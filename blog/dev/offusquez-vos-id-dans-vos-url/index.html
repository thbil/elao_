<!DOCTYPE html>
<html lang="fr">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Elao_</title>

                    <!-- Open Graph / Facebook -->
             <meta property="og:title" content="Elao_" />
            <meta property="og:locale" content="fr" />
            <meta name="description" content="Elao est un atelier de co-conception d&#039;applications web et mobile sur mesure." />
            <meta property="og:description" content="Elao est un atelier de co-conception d&#039;applications web et mobile sur mesure." />
            <link rel="canonical" href="https://elao.github.io/elao_/blog/dev/offusquez-vos-id-dans-vos-url" />
            <meta property="og:url" content="https://elao.github.io/elao_/blog/dev/offusquez-vos-id-dans-vos-url" />
            <meta property="og:site_name" content="elao_" />
            
            <!-- Twitter -->
            <meta property="twitter:card" content="summary">
            <meta property="twitter:title" content="Elao_">
            <meta property="twitter:description" content="Elao est un atelier de co-conception d&#039;applications web et mobile sur mesure.">
            <meta property="twitter:site" content="@tom32i">
            <meta property="twitter:creator" content="@tom32i">
                    
                    <link rel="stylesheet" href="/elao_/build/style.f8b7d93b.css">
            </head>
    <body>
        <header class="header">
            <div class="container">
                                    <!--
                        Todo :
                        - only on homepage : on scroll .logo.logo--animated becomes .logo.logo--animated.logo--active (triggers its animation)
                     -->
                    <a href="/elao_/">
                        <span class="screen-reader">Elao_</span>
                                                    <svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" viewBox="0 0 300 100" class="logo logo--animated">
                                <path d="M61.6,61.6H19.7C21,69,24.8,72.2,32.6,72.2c5.9,0,8.8-1.9,11.7-7.8l16.1,6.9C56.2,82,46.9,87.8,32.1,87.8
                                    c-19.1,0-32-12.6-32-31.6c0-19.5,12.6-32.6,31.4-32.6c18.1,0,30.3,12.6,30.3,31.6C61.7,57.2,61.7,58.9,61.6,61.6z M19.6,49.3h23.6
                                    c-0.2-7.9-4.1-10.9-11.3-10.9S20.7,41.8,19.6,49.3z"/>
                                <path d="M71.2,0.1H90v86.5H71.2V0.1z"/>
                                <path d="M166.1,24.7v61.8h-18.8V72.7c-3.5,9.8-10.5,15.1-20.4,15.1c-17.7,0-27.4-12.9-27.4-32
                                    c0-19.4,9.3-32.2,26.2-32.2c10.5,0,18,5.4,21.6,15.6V24.7H166.1z M147.9,55.7c0-10.4-4.8-15.2-15.1-15.2c-9.9,0-14.6,4.8-14.6,15.2
                                    c0,10.1,4.7,14.9,14.6,14.9C143.1,70.7,147.9,65.9,147.9,55.7L147.9,55.7z"/>
                                <path d="M242.8,55.8c0,19.9-15.3,32-33.6,32s-33.6-12.1-33.6-32s15.3-32.2,33.6-32.2S242.8,35.8,242.8,55.8z M224,55.8
                                    c0-10.4-4.7-15.2-14.8-15.2c-10.1,0-14.8,4.8-14.8,15.2c0,10.1,4.7,14.9,14.8,14.9S224,65.9,224,55.8L224,55.8z"/>
                                <rect x="243.1" y="86.5" width="56.7" height="15"/>
                            </svg>
                                            </a>
                
                
                                    <!-- Desktop nav -->
                    <nav class="nav">
                        <ul>
                                                            <li class="nav__item">
                                    <a href="/elao_/nos-services">
                                                                                <span>Nos services</span>
                                    </a>
                                </li>
                                                            <li class="nav__item">
                                    <a href="/elao_/methodo">
                                                                                <span>Notre méthodologie</span>
                                    </a>
                                </li>
                                                            <li class="nav__item">
                                    <a href="/elao_/nos-valeurs">
                                                                                <span>Nos valeurs</span>
                                    </a>
                                </li>
                                                            <li class="nav__item">
                                    <a href="/elao_/la-tribu/">
                                                                                <span>La tribu</span>
                                    </a>
                                </li>
                                                            <li class="nav__item">
                                    <a href="/elao_/blog/">
                                                                                <span>Blog</span>
                                    </a>
                                </li>
                                                            <li class="nav__item">
                                    <a href="/elao_/contact">
                                                                                    <i class="icon icon--contact" aria-hidden="true"></i>
                                                                                <span>Contact</span>
                                    </a>
                                </li>
                                                    </ul>
                    </nav>
                
                                    <!-- Mobile nav -->
                    <nav class="nav-mobile">
                        <div class="nav-mobile__header">
                            <a href="/elao_/">
                                                            <svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" viewBox="0 0 300 100" class="logo logo--animated">
                                <path d="M61.6,61.6H19.7C21,69,24.8,72.2,32.6,72.2c5.9,0,8.8-1.9,11.7-7.8l16.1,6.9C56.2,82,46.9,87.8,32.1,87.8
                                    c-19.1,0-32-12.6-32-31.6c0-19.5,12.6-32.6,31.4-32.6c18.1,0,30.3,12.6,30.3,31.6C61.7,57.2,61.7,58.9,61.6,61.6z M19.6,49.3h23.6
                                    c-0.2-7.9-4.1-10.9-11.3-10.9S20.7,41.8,19.6,49.3z"/>
                                <path d="M71.2,0.1H90v86.5H71.2V0.1z"/>
                                <path d="M166.1,24.7v61.8h-18.8V72.7c-3.5,9.8-10.5,15.1-20.4,15.1c-17.7,0-27.4-12.9-27.4-32
                                    c0-19.4,9.3-32.2,26.2-32.2c10.5,0,18,5.4,21.6,15.6V24.7H166.1z M147.9,55.7c0-10.4-4.8-15.2-15.1-15.2c-9.9,0-14.6,4.8-14.6,15.2
                                    c0,10.1,4.7,14.9,14.6,14.9C143.1,70.7,147.9,65.9,147.9,55.7L147.9,55.7z"/>
                                <path d="M242.8,55.8c0,19.9-15.3,32-33.6,32s-33.6-12.1-33.6-32s15.3-32.2,33.6-32.2S242.8,35.8,242.8,55.8z M224,55.8
                                    c0-10.4-4.7-15.2-14.8-15.2c-10.1,0-14.8,4.8-14.8,15.2c0,10.1,4.7,14.9,14.8,14.9S224,65.9,224,55.8L224,55.8z"/>
                                <rect x="243.1" y="86.5" width="56.7" height="15"/>
                            </svg>
                        
                            </a>
                            <button class="nav-toggle nav-toggle--close">
                                <i class="icon icon--close" aria-hidden="true"></i>
                                <span class="screen-reader">Fermer le menu</span>
                            </button>
                        </div>
                        <ul>
                                                            <li class="nav-mobile__item ">
                                    <a href="/elao_/nos-services">
                                                                                <span>Nos services</span>
                                    </a>
                                </li>
                                                            <li class="nav-mobile__item ">
                                    <a href="/elao_/methodo">
                                                                                <span>Notre méthodologie</span>
                                    </a>
                                </li>
                                                            <li class="nav-mobile__item ">
                                    <a href="/elao_/etudes-de-cas/">
                                                                                <span>Nos études de cas</span>
                                    </a>
                                </li>
                                                            <li class="nav-mobile__item ">
                                    <a href="/elao_/nos-valeurs">
                                                                                <span>Nos valeurs</span>
                                    </a>
                                </li>
                                                            <li class="nav-mobile__item ">
                                    <a href="/elao_/la-tribu/">
                                                                                <span>La tribu</span>
                                    </a>
                                </li>
                                                            <li class="nav-mobile__item ">
                                    <a href="/elao_/blog/">
                                                                                <span>Blog</span>
                                    </a>
                                </li>
                                                            <li class="nav-mobile__item nav-mobile__item--large">
                                    <a href="/elao_/contact">
                                                                                    <i class="icon icon--contact" aria-hidden="true"></i>
                                                                                <span>Contact</span>
                                    </a>
                                </li>
                                                    </ul>
                    </nav>
                    <button class="nav-toggle nav-toggle--open">
                        <i class="icon icon--hamburger" aria-hidden="true"></i>
                        <span class="screen-reader">Ouvrir le menu</span>
                    </button>
                            </div>
        </header>
        <div class="container">
        <main>
              <ul class="breadcrumb">
    <li class="breadcrumb__item">
      <a href="/elao_/blog/">Blog</a>
    </li>
    <li class="breadcrumb__item">
      Offusquez vos id dans vos url
    </li>
  </ul>

  <div class="article-banner">
    <div class="article-banner__cover" style="background: #f1f1f1 url(/elao_/images/posts/thumbnails/obfuscation.jpg)"></div>

    <div class="article-info">
                    <div class="article-author ">
          <div class="article-author__image">
                          <img src="/elao_/images/authors/mcolin.jpg" />
                      </div>
          <span class="article-author__info">
            Écrit par
                          <strong>Maxime COLIN</strong>
                      </span>
        </div>
            <div class="article-info__date">
        <span>Publication <strong>6 novembre 2019</strong></span>
        <span>Modification <strong>10 octobre 2020</strong></span>
      </div>
    </div>

    <div class="article-header">
      <h1>Offusquez vos id dans vos url</h1>
      <p>Découverte d&#039;alternatives aux ID auto-incrémentés dans les urls et leur mise en place dans le framework Symfony.</p>
      <ul class="article-tag-list">
                  <li class="article-tag-list__item">
            <a href="/elao_/blog/tag/Securite">#Securite</a>
          </li>
                  <li class="article-tag-list__item">
            <a href="/elao_/blog/tag/PHP">#PHP</a>
          </li>
                  <li class="article-tag-list__item">
            <a href="/elao_/blog/tag/Symfony">#Symfony</a>
          </li>
                  <li class="article-tag-list__item">
            <a href="/elao_/blog/tag/Framework">#Framework</a>
          </li>
              </ul>
    </div>
  </div>

  
  <div class="article-content">
    <main class="article-content__main">
      <body><p>L'une des pratiques les plus courantes du web pour accéder à un contenu de base de données est d'inclure l'identifiant (<code class="code-inline" id="b718adec73e04ce3ec720dd11a06a308">ID</code>) de celui-ci dans l'url. Cet identifiant est dans la grande majorité des cas un entier positif auto-incrémenté par la base de données. Cet identifiant se retrouve ainsi exposé dans les urls. Bien qu'elle pose un certain nombre de problèmes, cette pratique est très simple et très répandue.</p>
<h2 id="probl-mes-de-s-curit-et-de-c" class="anchor-title"><a href="#probl-mes-de-s-curit-et-de-c">Problèmes de sécurité et de confidentialité</a></h2>
<p>Exposer ces identifiants dans les urls pose principalement des problèmes de <strong>sécurité</strong> et de <strong>confidentialité</strong>.</p>
<p>Ces problèmes sont dus à la prédictabilité de l'identifiant. En effet, celui-ci étant auto-incrémenté, si vous avez une url avec un identifiant, il est très facile de déduire les urls d'autres contenus en incrémentant ou décrémentant l'identifiant dans l'url.</p>
<p>Il est alors simple pour un attaquant ou simplement un utilisateur curieux de tenter d'accéder à des contenus qui ne lui sont pas destinés. Couplé à d'autres failles ou défauts de sécurité, cela lui facilitera grandement la tâche. Il est également simple de crawler votre contenu sans connaitre à l'avance toutes les urls, mais simplement en bouclant sur un identifiant incrémenté.</p>
<p>Et enfin, il est également simple de connaitre vos volumes de données. Par exemple, si je m'inscris sur un site et que je vois dans une url que mon compte utilisateur à l'ID 100, je sais qu'il n'y a que 100 utilisateurs inscrits sur ce site, si je passe une commande et qu'elle a l'identifiant 30, je sais qu'il n'y a eu que 30 commandes et je peux ensuite déduire le nombre de commandes moyen par utilisateur. Autant d'informations sensibles, surtout si vous êtes en concurrence.</p>
<h2 id="les-alternatives-aux-ids-auto-in" class="anchor-title"><a href="#les-alternatives-aux-ids-auto-in">Les alternatives aux IDs auto-incrémentés</a></h2>
<p>Plusieurs alternatives aux identifiants auto-incrémentés existent.</p>
<p>L'une des plus connues est l'<strong><a href="https://fr.wikipedia.org/wiki/Universal_Unique_Identifier" target="_blank">UUID</a></strong>. Cet identifiant de 32 caractères hexadécimaux est généré de façon unique par un algorithme. A partir de l'UUID d'un contenu il n'est pas possible de prédire celui des autres. Il est très utilisé lors d'échanges API; néanmoins il souffre d'un inconvéniant majeur pour des urls, sa longueur.</p>
<p>L'url suivante est quand même beaucoup moins lisible et pratique que la même utilisant des IDs entiers :</p>
<figure><pre>https://www.example.com/shop/category/b441a884-5d46-423b-8317-ddb6f7e3f2fb/product/f0283088-5bd3-4acc-bc42-e6d173d33dd8?filter=165779fc-171d-4f3c-8c60-a2351d6468d3</pre>
  <figcaption>Une url avec des UUIDs</figcaption></figure><figure><pre>https://www.example.com/shop/category/3/product/56?filter=33</pre>
  <figcaption>Une url avec des IDs</figcaption></figure><p>Une autre solution pourrait être d'utiliser des <strong>identifiants entiers non auto-incrémentés</strong>. Cela nécessite néanmoins la mise en place d'un algorithme permettant de générer de manière unique ces identifiants. C'est une solution qui peut être viable, mais pas forcement simple à mettre en place et la perte d'auto-increment côté base de données peut être handicapant.</p>
<h2 id="l-offuscation" class="anchor-title"><a href="#l-offuscation">L'offuscation</a></h2>
<p>Afin de conserver mes identifiants auto-incrementés en interne mais de ne pas les exposer j'ai opté pour l'<a href="https://fr.wikipedia.org/wiki/Offuscation" target="_blank">offuscation</a>. Le principe est simple, mes IDs sont encodés avant d'être inséré dans les urls puis décodés à chaque requête de façon à ce que l'utilisateur ne voie jamais les vrais IDs.</p>
<p>En PHP il existe plusieurs bibliothèques permettant d'offusquer un ID numérique, encodant un entier en une chaîne héxadécidémale, une chaîne base64 ou un autre entier par exemple.</p>
<ul><li><a href="https://hashids.org/" target="_blank">hashids</a></li>
<li><a href="https://github.com/zackkitzmiller/tiny-php" target="_blank">zackkitzmiller/tiny</a></li>
<li><a href="https://github.com/marekweb/opaque-id" target="_blank">marekweb/opaque-id</a></li>
<li><a href="https://github.com/jenssegers/optimus" target="_blank">jenssegers/optimus</a></li>
</ul><p>J'ai utilisé <a href="https://github.com/jenssegers/optimus" target="_blank"><strong>optimus</strong></a> qui transforme votre ID en un autre entier. Néanmoins n'importe quelle autre bibliothèque fonctionnera pour la suite de cette article.</p>
<pre class="code-multiline language-php"><code class="language-php" id="20328f69ecbe43bfd9ffba3cb1b6d80b"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token variable">$optimus</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Optimus</span><span class="token punctuation">(</span><span class="token number">1580030173</span><span class="token punctuation">,</span> <span class="token number">59260789</span><span class="token punctuation">,</span> <span class="token number">1163945558</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$encoded</span> <span class="token operator">=</span> <span class="token variable">$optimus</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1535832388</span>
<span class="token variable">$original</span> <span class="token operator">=</span> <span class="token variable">$optimus</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">decode</span><span class="token punctuation">(</span><span class="token number">1535832388</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 20</span></span></code></pre>
<style type="text/css">
figure figcaption {
  text-align: center;
  font-style: italic;
  font-size: 80%;
}

figure pre {
  margin: 0;
}

figure {
  margin: 20px 0;
}
</style><h2 id="int-gration-dans-symfony" class="anchor-title"><a href="#int-gration-dans-symfony">Intégration dans Symfony</a></h2>
<p>Tout d'abord créons un service pour offusquer nos IDs.</p>
<pre class="code-multiline language-php"><code class="language-php" id="8993fa175afbc254aba58d400993c99c"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">interface</span> <span class="token class-name">ObfuscatorInterface</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">obfuscate</span><span class="token punctuation">(</span>int <span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">:</span> int<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">deobfuscate</span><span class="token punctuation">(</span>int <span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">:</span> int<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">OptimusObfuscator</span> <span class="token keyword">implements</span> <span class="token class-name">ObfuscatorInterface</span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token variable">$optimus</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span>Optimus <span class="token variable">$optimus</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token this">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">optimus</span> <span class="token operator">=</span> <span class="token variable">$optimus</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">obfuscate</span><span class="token punctuation">(</span>int <span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">:</span> int
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token this">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">optimus</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">deobfuscate</span><span class="token punctuation">(</span>int <span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">:</span> int
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token this">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">optimus</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">decode</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></span></code></pre>
<p>Configurons le service avec les générateurs.</p>
<pre class="code-multiline language-yaml"><code class="language-yaml" id="81fb9888f28562106e0d23fe1312fe72"><span class="token key atrule">parameters</span><span class="token punctuation">:</span>
    <span class="token key atrule">env(APP_OPTIMUS_PRIME)</span><span class="token punctuation">:</span> <span class="token string">"1580030173"</span>
    <span class="token key atrule">env(APP_OPTIMUS_INVERSE)</span><span class="token punctuation">:</span> <span class="token string">"59260789"</span>
    <span class="token key atrule">env(APP_OPTIMUS_XOR)</span><span class="token punctuation">:</span> <span class="token string">"1163945558"</span>
    <span class="token key atrule">env(APP_OPTIMUS_SIZE)</span><span class="token punctuation">:</span> <span class="token string">"31"</span>

<span class="token key atrule">services</span><span class="token punctuation">:</span>
    <span class="token key atrule">_defaults</span><span class="token punctuation">:</span>
        <span class="token key atrule">autowire</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token key atrule">autoconfigure</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>

    <span class="token key atrule">Jenssegers\Optimus\Optimus</span><span class="token punctuation">:</span>
        <span class="token key atrule">$prime</span><span class="token punctuation">:</span> <span class="token string">'%env(APP_OPTIMUS_PRIME)%'</span>
        <span class="token key atrule">$inverse</span><span class="token punctuation">:</span> <span class="token string">'%env(APP_OPTIMUS_INVERSE)%'</span>
        <span class="token key atrule">$xor</span><span class="token punctuation">:</span> <span class="token string">'%env(APP_OPTIMUS_XOR)%'</span>
        <span class="token key atrule">$size</span><span class="token punctuation">:</span> <span class="token string">'%env(APP_OPTIMUS_SIZE)%'</span></code></pre>
<blockquote>
<p>La bibiothèque met à disposition une commande pour générer les paramètres à injecter à <em>Optimus</em> : <code class="code-inline" id="fcc4bcf1bebc979abbbac9ee039b0345">php vendor/bin/optimus spark</code>.
Plus d'informations sur ces paramètres dans la <a href="https://github.com/jenssegers/optimus/blob/master/README.md" target="_blank">documentation</a>.</p>
</blockquote>
<p>Ensuite, afin de ne pas avoir à encoder nous-mêmes les IDs, créons un decorator pour le router Symfony.</p>
<p>Voici un exemple simple qui <strong>offusque</strong> tous les paramètres <code class="code-inline" id="b80bb7740288fda1f201890375a60c8f">id</code> des routes.</p>
<pre class="code-multiline language-php"><code class="language-php" id="fc63f1869e129a1138c1eb15c1430a89"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">class</span> <span class="token class-name">ObfuscatorUrlGenerator</span> <span class="token keyword">implements</span> <span class="token class-name">RouterInterface</span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token variable">$inner</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token variable">$obfuscator</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span>RouterInterface <span class="token variable">$inner</span><span class="token punctuation">,</span> ObfuscatorInterface <span class="token variable">$obfuscator</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token this">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">inner</span> <span class="token operator">=</span> <span class="token variable">$inner</span><span class="token punctuation">;</span>
        <span class="token this">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">obfuscator</span> <span class="token operator">=</span> <span class="token variable">$obfuscator</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">generate</span><span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">,</span> <span class="token variable">$parameters</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$referenceType</span> <span class="token operator">=</span> <span class="token scope"><span class="token keyword">self</span><span class="token punctuation">::</span></span><span class="token constant">ABSOLUTE_PATH</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$parameters</span> <span class="token keyword">as</span> <span class="token variable">$key</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token variable">$value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$key</span> <span class="token operator">===</span> <span class="token single-quoted-string string">'id'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token variable">$parameters</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token this">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">obfuscator</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">obfuscate</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token this">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">inner</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">generate</span><span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">,</span> <span class="token variable">$parameters</span><span class="token punctuation">,</span> <span class="token variable">$referenceType</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">match</span><span class="token punctuation">(</span><span class="token variable">$pathinfo</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$parameters</span> <span class="token operator">=</span> <span class="token this">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">inner</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token variable">$pathinfo</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$parameters</span> <span class="token keyword">as</span> <span class="token variable">$key</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token variable">$value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$key</span> <span class="token operator">===</span> <span class="token single-quoted-string string">'id'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token variable">$parameters</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token this">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">obfuscator</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">deobfuscate</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token variable">$parameters</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">setContext</span><span class="token punctuation">(</span>RequestContext <span class="token variable">$context</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token this">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">inner</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">setContext</span><span class="token punctuation">(</span><span class="token variable">$context</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token this">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">inner</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">getRouteCollection</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token this">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">inner</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getRouteCollection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></span></code></pre>
<pre class="code-multiline language-yaml"><code class="language-yaml" id="a7795e16e0cb024b0c4a9497f00f2861"><span class="token key atrule">services</span><span class="token punctuation">:</span>
    <span class="token key atrule">App\Routing\ObfuscatorUrlGenerator</span><span class="token punctuation">:</span>
        <span class="token key atrule">decorates</span><span class="token punctuation">:</span> router
        <span class="token key atrule">decoration_priority</span><span class="token punctuation">:</span> <span class="token number">1</span>
        <span class="token key atrule">arguments</span><span class="token punctuation">:</span>
            <span class="token key atrule">$inner</span><span class="token punctuation">:</span> <span class="token string">"@App\Routing\ObfuscatorUrlGenerator.inner"</span></code></pre>
<p>Ainsi, notre router offusque automatiquement nos <code class="code-inline" id="b80bb7740288fda1f201890375a60c8f">id</code> lors de la génération d'url :</p>
<pre class="code-multiline language-twig"><code class="language-twig" id="d6997235508b6b0f3651776fdac1de49"><span class="token tag"><span class="token ld"><span class="token punctuation">{{</span></span> <span class="token property">path</span><span class="token punctuation">(</span><span class="token string"><span class="token punctuation">'</span>ma_route<span class="token punctuation">'</span></span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token property">id</span><span class="token punctuation">:</span> <span class="token number">20</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token rd"><span class="token punctuation">}}</span></span></span> <span class="token comment">{# /ma/route/1535832388 #}</span></code></pre>
<p>Et désoffusque nos <code class="code-inline" id="b80bb7740288fda1f201890375a60c8f">id</code> lors de la correspondance d'url nous permettant d'accéder à notre <code class="code-inline" id="b80bb7740288fda1f201890375a60c8f">id</code> en clair dans nos controller :</p>
<pre class="code-multiline language-php"><code class="language-php" id="a6d6176b13d0c57a1e8ee8048ab13236"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">class</span> <span class="token class-name">MaRouteController</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__invoke</span><span class="token punctuation">(</span>int <span class="token variable">$id</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// $id = 20</span>

        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></span></code></pre>
<h2 id="rendre-notre-syst-me-configurab" class="anchor-title"><a href="#rendre-notre-syst-me-configurab">Rendre notre système configurable</a></h2>
<p>Notre offuscation fonctionne mais uniquement sur les paramètres <code class="code-inline" id="b80bb7740288fda1f201890375a60c8f">id</code>. Nous aurons peut être besoin d'offusquer d'autres paramètres ou d'exclure certaines routes.</p>
<p>Pour cela ajoutons une méthode <code class="code-inline" id="cd3c6265a726bca865fe9b74b4fd5ec4">mustBeObfuscated</code> à notre <code class="code-inline" id="9f484bcd1b56f5125466c648f60d7671">Obfuscator</code> et déportons y la logique utilisée dans le router et dans le resolver :</p>
<pre class="code-multiline language-diff"><code class="language-diff" id="622fa2f3e414c83da7b9c74d038aac09"><span class="token deleted-arrow deleted"><span class="token prefix deleted">&lt;</span><span class="token line">?php
</span></span>class Obfuscator
{
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">   // ...
</span></span>
<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">    public function mustBeObfuscated(string $routeName, string $argumentName): bool
</span><span class="token prefix inserted">+</span><span class="token line">    {
</span><span class="token prefix inserted">+</span><span class="token line">        return $argumentName === 'id';
</span><span class="token prefix inserted">+</span><span class="token line">    }
</span></span>}

class ObfuscatorUrlGenerator implements RouterInterface
{
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">   // ...
</span></span>
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">   public function generate($name, $parameters = [], $referenceType = self::ABSOLUTE_PATH)
</span><span class="token prefix unchanged"> </span><span class="token line">   {
</span><span class="token prefix unchanged"> </span><span class="token line">       foreach ($parameters as $key =&gt; $value) {
</span></span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line">            if ($key === 'id') {
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">            if ($this-&gt;obfuscator-&gt;mustBeObfuscated($name, $key))
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">               $parameters[$key] = $this-&gt;obfuscator-&gt;obfuscate($value);
</span><span class="token prefix unchanged"> </span><span class="token line">           }
</span><span class="token prefix unchanged"> </span><span class="token line">       }
</span></span>
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">       return $this-&gt;inner-&gt;setContext($name, $parameters, $referenceType);
</span><span class="token prefix unchanged"> </span><span class="token line">   }
</span></span>
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">   public function match($pathinfo)
</span><span class="token prefix unchanged"> </span><span class="token line">   {
</span><span class="token prefix unchanged"> </span><span class="token line">       $parameters = $this-&gt;inner-&gt;match($pathinfo);
</span></span>
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">       foreach ($parameters as $key =&gt; $value) {
</span></span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line">            if ($key === 'id') {
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">            if ($this-&gt;obfuscator-&gt;mustBeObfuscated($parameters['_route'], $key)) {
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">               $parameters[$key] = $this-&gt;obfuscator-&gt;deobfuscate($value);
</span><span class="token prefix unchanged"> </span><span class="token line">           }
</span><span class="token prefix unchanged"> </span><span class="token line">       }
</span></span>
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">       return $parameters;
</span><span class="token prefix unchanged"> </span><span class="token line">   }
</span></span>}</code></pre>
<p>Cette méthode peut alors être personnalisée pour savoir si un paramètre doit être offusqué selon son nom et sa route.</p>
<p>Par exemple, en se basant sur un tableau contenant pour chaque route les paramètres à offusquer :</p>
<pre class="code-multiline language-php"><code class="language-php" id="dc7c3a8e20fd8bc91a3a21d5e2b0fb06"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">class</span> <span class="token class-name">Obfuscator</span>
<span class="token punctuation">{</span>
    <span class="token comment">// ...</span>

    <span class="token keyword">private</span> <span class="token variable">$routes</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
       <span class="token single-quoted-string string">'une_route'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span><span class="token single-quoted-string string">'id'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token single-quoted-string string">'une_autre_route'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span><span class="token single-quoted-string string">'categoryId'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'productId'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">mustBeObfuscated</span><span class="token punctuation">(</span>string <span class="token variable">$routeName</span><span class="token punctuation">,</span> string <span class="token variable">$argumentName</span><span class="token punctuation">)</span><span class="token punctuation">:</span> bool
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token this">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">routes</span><span class="token punctuation">[</span><span class="token variable">$routeName</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token operator">&amp;&amp;</span> <span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$argumentName</span><span class="token punctuation">,</span> <span class="token this">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">routes</span><span class="token punctuation">[</span><span class="token variable">$routeName</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></span></code></pre>
<p>Pour aller plus loin, nous pouvons baser ce tableau de routes sur un fichier de configuration, sur des attributs ou des options dans le fichier de routing, sur une convention de nommage ou implémenter toute autre logique dans la méthode <code class="code-inline" id="cd3c6265a726bca865fe9b74b4fd5ec4">mustBeObfuscated</code>.</p></body>
                        </main>
    <aside class="article-content__aside">
      <button class="kudo">
        <span class="kudo__button" aria-hidden="true"></span>
        <span class="screen-reader">Cet article m’a été utile</span>
        <span class="kudo__label" aria-hidden="true">Kudos</span>
      </button>
    </aside>
  </div>

  <div class="article-footer">
                  <div class="article-author">
          <div class="article-author__image">
            <img src="/elao_/images/authors/mcolin.jpg" />
          </div>
          <span class="article-author__info">
            Écrit par
            <strong>Maxime COLIN</strong>
          </span>
          <div class="article-author__social">
                          <a href="https://twitter.com/colin_maxime" class="social social--small">
                <i class="icon icon--twitter" aria-hidden="true"></i>
                <span class="screen-reader">Compte twitter de Maxime COLIN</span>
              </a>
                                      <a href="https://github.com/maximecolin "class="social social--small">
                <i class="icon icon--github" aria-hidden="true"></i>
                <span class="screen-reader">Compte github de Maxime COLIN</span>
              </a>
                                      <a href="http://www.maximecolin.fr" class="social social--small">
                <i class="icon icon--website" aria-hidden="true"></i>
                <span class="screen-reader">Site personnel de Maxime COLIN</span>
              </a>
                      </div>
        </div>
            </div>
        </main>
                    <footer class="footer">
                <section class="footer__links">
                    <p class="h1 h1--small">
                        elao
                        <span>développe</span>
                         <span>du lien</span>
                    </p>
                    <div class="links">
                        <ul>
                            <li>
                                <a href="/elao_/nos-services">Nos services</a>
                            </li>
                            <li>
                                <a href="/elao_/etudes-de-cas/">Nos études de cas</a>
                            </li>
                            <li>
                                <a href="/elao_/blog/">Blog</a>
                            </li>
                            <li>
                                <a href="/elao_/methodo">Notre méthodologie</a>
                            </li>
                            <li>
                                <a href="/elao_/la-tribu/">La tribu</a>
                            </li>
                            <li>
                                <a href="/elao_/contact">Contact</a>
                            </li>
                            <li>
                                <a href="/elao_/nos-valeurs">Nos valeurs</a>
                            </li>
                            <li>
                                                                <a href="/elao_/recrutement/">
                                    Nous recrutons
                                                                            <span class="bullet">2</span>
                                                                    </a>
                            </li>
                        </ul>
                    </div>
                    <div class="socials">
                        <ul>
                            <li>
                                <a href="https://github.com/elao">
                                    <i class="icon icon--github"></i>
                                    Github
                                </a>
                            </li>
                            <li>
                                <a href="https://twitter.com/elao">
                                    <i class="icon icon--twitter"></i>
                                    Twitter
                                </a>
                            </li>
                            <li>
                                <a href="https://www.instagram.com/elao_agency/">
                                    <i class="icon icon--instagram"></i>
                                    Instagram
                                </a>
                            </li>
                        </ul>
                    </div>
                </section>
                <section class="footer__legals">
                    <span>© 2014/2020 - ELAO - Tous droits réservés</span>
                    <a href="/elao_/legal">Mentions légales</a>
                    <a href="/elao_/privacy">Protection des données</a>
                </section>
            </footer>
        </div>
                            <script src="/elao_/build/runtime.3ea599f4.js"></script><script src="/elao_/build/0.4fc588e5.js"></script><script src="/elao_/build/app.67723742.js"></script>
                    </body>
</html>
