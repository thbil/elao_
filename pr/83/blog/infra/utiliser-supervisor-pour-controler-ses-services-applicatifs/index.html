<!DOCTYPE html>
<html lang="fr">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Elao_</title>

                    <meta name="description" content="Elao est un atelier de co-conception d&#039;applications web et mobile sur mesure." />
            <link rel="canonical" href="https://elao.github.io/elao_/pr/83/blog/infra/utiliser-supervisor-pour-controler-ses-services-applicatifs" />

            <!-- Open Graph / Facebook -->
            <meta property="og:title" content="Elao_" />
            <meta property="og:locale" content="fr" />
            <meta property="og:description" content="Elao est un atelier de co-conception d&#039;applications web et mobile sur mesure." />
            <meta property="og:url" content="https://elao.github.io/elao_/pr/83/blog/infra/utiliser-supervisor-pour-controler-ses-services-applicatifs" />
            <meta property="og:site_name" content="elao_" />
                        
            <!-- Twitter -->
            <meta property="twitter:card" content="summary">
            <meta property="twitter:title" content="Elao_">
            <meta property="twitter:description" content="Elao est un atelier de co-conception d&#039;applications web et mobile sur mesure.">
            <meta property="twitter:site" content="@elao">
            <meta property="twitter:creator" content="@elao">
                                
        <!-- Optional no-index -->
        
                    <link rel="stylesheet" href="/elao_/pr/83/build/style.a104ee87.css">
            </head>
    <body>
        <header class="header">
            <div class="container">
                                    <!--
                        Todo :
                        - only on homepage : on scroll .logo.logo--animated becomes .logo.logo--animated.logo--active (triggers its animation)
                     -->
                    <a href="/elao_/pr/83/">
                        <span class="screen-reader">Elao_</span>
                                                    <svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" viewBox="0 0 300 100" class="logo logo--animated">
                                <path d="M61.6,61.6H19.7C21,69,24.8,72.2,32.6,72.2c5.9,0,8.8-1.9,11.7-7.8l16.1,6.9C56.2,82,46.9,87.8,32.1,87.8
                                    c-19.1,0-32-12.6-32-31.6c0-19.5,12.6-32.6,31.4-32.6c18.1,0,30.3,12.6,30.3,31.6C61.7,57.2,61.7,58.9,61.6,61.6z M19.6,49.3h23.6
                                    c-0.2-7.9-4.1-10.9-11.3-10.9S20.7,41.8,19.6,49.3z"/>
                                <path d="M71.2,0.1H90v86.5H71.2V0.1z"/>
                                <path d="M166.1,24.7v61.8h-18.8V72.7c-3.5,9.8-10.5,15.1-20.4,15.1c-17.7,0-27.4-12.9-27.4-32
                                    c0-19.4,9.3-32.2,26.2-32.2c10.5,0,18,5.4,21.6,15.6V24.7H166.1z M147.9,55.7c0-10.4-4.8-15.2-15.1-15.2c-9.9,0-14.6,4.8-14.6,15.2
                                    c0,10.1,4.7,14.9,14.6,14.9C143.1,70.7,147.9,65.9,147.9,55.7L147.9,55.7z"/>
                                <path d="M242.8,55.8c0,19.9-15.3,32-33.6,32s-33.6-12.1-33.6-32s15.3-32.2,33.6-32.2S242.8,35.8,242.8,55.8z M224,55.8
                                    c0-10.4-4.7-15.2-14.8-15.2c-10.1,0-14.8,4.8-14.8,15.2c0,10.1,4.7,14.9,14.8,14.9S224,65.9,224,55.8L224,55.8z"/>
                                <rect x="243.1" y="86.5" width="56.7" height="15"/>
                            </svg>
                                            </a>
                
                
                                    <!-- Desktop nav -->
                    <nav class="nav">
                        <ul>
                                                            <li class="nav__item">
                                    <a href="/elao_/pr/83/nos-services">
                                                                                <span>Nos services</span>
                                    </a>
                                </li>
                                                            <li class="nav__item">
                                    <a href="/elao_/pr/83/methodo">
                                                                                <span>Notre méthodologie</span>
                                    </a>
                                </li>
                                                            <li class="nav__item">
                                    <a href="/elao_/pr/83/nos-valeurs">
                                                                                <span>Nos valeurs</span>
                                    </a>
                                </li>
                                                            <li class="nav__item">
                                    <a href="/elao_/pr/83/la-tribu/">
                                                                                <span>La tribu</span>
                                    </a>
                                </li>
                                                            <li class="nav__item">
                                    <a href="/elao_/pr/83/blog/">
                                                                                <span>Blog</span>
                                    </a>
                                </li>
                                                            <li class="nav__item">
                                    <a href="/elao_/pr/83/contact">
                                                                                    <i class="icon icon--contact" aria-hidden="true"></i>
                                                                                <span>Contact</span>
                                    </a>
                                </li>
                                                    </ul>
                    </nav>
                
                                    <!-- Mobile nav -->
                    <nav class="nav-mobile">
                        <div class="nav-mobile__header">
                            <a href="/elao_/pr/83/">
                                                            <svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" viewBox="0 0 300 100" class="logo logo--animated">
                                <path d="M61.6,61.6H19.7C21,69,24.8,72.2,32.6,72.2c5.9,0,8.8-1.9,11.7-7.8l16.1,6.9C56.2,82,46.9,87.8,32.1,87.8
                                    c-19.1,0-32-12.6-32-31.6c0-19.5,12.6-32.6,31.4-32.6c18.1,0,30.3,12.6,30.3,31.6C61.7,57.2,61.7,58.9,61.6,61.6z M19.6,49.3h23.6
                                    c-0.2-7.9-4.1-10.9-11.3-10.9S20.7,41.8,19.6,49.3z"/>
                                <path d="M71.2,0.1H90v86.5H71.2V0.1z"/>
                                <path d="M166.1,24.7v61.8h-18.8V72.7c-3.5,9.8-10.5,15.1-20.4,15.1c-17.7,0-27.4-12.9-27.4-32
                                    c0-19.4,9.3-32.2,26.2-32.2c10.5,0,18,5.4,21.6,15.6V24.7H166.1z M147.9,55.7c0-10.4-4.8-15.2-15.1-15.2c-9.9,0-14.6,4.8-14.6,15.2
                                    c0,10.1,4.7,14.9,14.6,14.9C143.1,70.7,147.9,65.9,147.9,55.7L147.9,55.7z"/>
                                <path d="M242.8,55.8c0,19.9-15.3,32-33.6,32s-33.6-12.1-33.6-32s15.3-32.2,33.6-32.2S242.8,35.8,242.8,55.8z M224,55.8
                                    c0-10.4-4.7-15.2-14.8-15.2c-10.1,0-14.8,4.8-14.8,15.2c0,10.1,4.7,14.9,14.8,14.9S224,65.9,224,55.8L224,55.8z"/>
                                <rect x="243.1" y="86.5" width="56.7" height="15"/>
                            </svg>
                        
                            </a>
                            <button class="nav-toggle nav-toggle--close">
                                <i class="icon icon--close" aria-hidden="true"></i>
                                <span class="screen-reader">Fermer le menu</span>
                            </button>
                        </div>
                        <ul>
                                                            <li class="nav-mobile__item ">
                                    <a href="/elao_/pr/83/nos-services">
                                                                                <span>Nos services</span>
                                    </a>
                                </li>
                                                            <li class="nav-mobile__item ">
                                    <a href="/elao_/pr/83/methodo">
                                                                                <span>Notre méthodologie</span>
                                    </a>
                                </li>
                                                            <li class="nav-mobile__item ">
                                    <a href="/elao_/pr/83/etudes-de-cas/">
                                                                                <span>Nos études de cas</span>
                                    </a>
                                </li>
                                                            <li class="nav-mobile__item ">
                                    <a href="/elao_/pr/83/nos-valeurs">
                                                                                <span>Nos valeurs</span>
                                    </a>
                                </li>
                                                            <li class="nav-mobile__item ">
                                    <a href="/elao_/pr/83/la-tribu/">
                                                                                <span>La tribu</span>
                                    </a>
                                </li>
                                                            <li class="nav-mobile__item ">
                                    <a href="/elao_/pr/83/blog/">
                                                                                <span>Blog</span>
                                    </a>
                                </li>
                                                            <li class="nav-mobile__item nav-mobile__item--large">
                                    <a href="/elao_/pr/83/contact">
                                                                                    <i class="icon icon--contact" aria-hidden="true"></i>
                                                                                <span>Contact</span>
                                    </a>
                                </li>
                                                    </ul>
                    </nav>
                    <button class="nav-toggle nav-toggle--open">
                        <i class="icon icon--hamburger" aria-hidden="true"></i>
                        <span class="screen-reader">Ouvrir le menu</span>
                    </button>
                            </div>
        </header>
        <div class="container">
        <main>
              <ul class="breadcrumb">
    <li class="breadcrumb__item">
      <a href="/elao_/pr/83/blog/">Blog</a>
    </li>
    <li class="breadcrumb__item">
      Controller ses services applicatifs avec supervisor
    </li>
  </ul>

  <div class="article-banner">
    <div class="article-banner__cover" style="background: #f1f1f1 url(/elao_/pr/83/images/posts/thumbnails/ice_bulb.jpg)"></div>

    <div class="article-info">
                    <div class="article-author ">
          <div class="article-author__image">
                          <img src="/elao_/pr/83/images/authors/gfaivre.jpg" />
                      </div>
          <span class="article-author__info">
            Écrit par
                          <strong>Guewen FAIVRE</strong>
                      </span>
        </div>
            <div class="article-info__date">
        <span>Publication <strong>22 décembre 2014</strong></span>
        <span>Modification <strong>4 février 2021</strong></span>
      </div>
    </div>

    <div class="article-header">
      <h1>Controller ses services applicatifs avec supervisor</h1>
      <p>Supervisor est un système de contrôle des processus/services applicatifs destiné aux systèmes de types UNIX.</p>
      <ul class="article-tag-list">
                  <li class="article-tag-list__item">
            <a href="/elao_/pr/83/blog/tag/Services" rel="nofollow">#Services</a>
          </li>
                  <li class="article-tag-list__item">
            <a href="/elao_/pr/83/blog/tag/Infra" rel="nofollow">#Infra</a>
          </li>
                  <li class="article-tag-list__item">
            <a href="/elao_/pr/83/blog/tag/Linux" rel="nofollow">#Linux</a>
          </li>
                  <li class="article-tag-list__item">
            <a href="/elao_/pr/83/blog/tag/Debian" rel="nofollow">#Debian</a>
          </li>
                  <li class="article-tag-list__item">
            <a href="/elao_/pr/83/blog/tag/Supervisor" rel="nofollow">#Supervisor</a>
          </li>
              </ul>
    </div>
  </div>

  
  <div class="article-content">
    <main class="article-content__main">
      <body><p>Bonjour à tous,</p>
<p>Aujourd'hui nous allons faire le tour d'une solution fort sympathique que nous utilisons @elao pour faire tourner certains services applicatifs.</p>
<p>Son petit nom ? <a href="http://supervisord.org/" target="_blank"><strong>Supervisor</strong></a>.</p>
<h1 id="introduction">Introduction</h1>
<p>Supervisor est un petit outil codé en Python et permettant d'assurer le suivi et le contrôle de services/processus applicatifs sur des systèmes de type UNIX.</p>
<p>On peut le comparer à launchd (utilisé par OSX) ou <a href="http://smarden.org/runit/" target="_blank"><strong>runit</strong></a>. Attention toutefois il n'est pas destiné à remplacer le process init des systèmes UNIX. Il est par contre le parfait allié pour lancer et suivre des services applicatifs liés à un projet et qui doivent être démarrés et disponibles en permanence.</p>
<p>On peut notamment penser à des services NodeJS ou autres.</p>
<p>Supervisor est disponible en paquet Debian en version 3.0, l'installation est donc très facile :</p>
<pre class="code-multiline"><code id="a47b359ccd7dcf8a0f9ebaf1023ffb84">apt-get install supervisor</code></pre>
<p>Supervisor est divisé en deux composants différents.</p>
<h2 id="supervisord">Supervisord</h2>
<p>Supervisord est la partie qui a la responsabilité de démarrer les services configurés et de les redémarrer en cas de crash.
Il est configurable via le fichier <code class="code-inline" id="53585b857fac1155a055cfb706951271">/etc/supervisor/supervisord.conf</code></p>
<h2 id="supervisorctl">Supervisorctl</h2>
<p><strong>Supervisorctl</strong> est le client permettant d'administrer les services gérés par supervisor. Il est capable de se connecter à plusieurs démons <strong>supervisord</strong>  et permet de démarrer / arrêter des services. Il est possible de les faire fonctionner soit via une socket soit via TCP. Il est également possible de gérer une authentification lors de la connexion au démon.</p>
<h1 id="utiliser-supervisor">Utiliser supervisor</h1>
<h2 id="ajouter-un-service-a-supervisor">Ajouter un service à Supervisor</h2>
<p>Pour ajouter un service à supervisor il suffit de le déclarer en ajoutant un fichier dans <code class="code-inline" id="35dd810a7ec81a0bcfadd24ef5eb125f">/etc/supervisor/conf.d</code>.</p>
<p>Attention celui-ci doit se terminer par l'extension <code class="code-inline" id="a2b11a8323f2bacebd54851aea409219">.conf</code> pour être correctement pris en compte par le démon.</p>
<pre class="code-multiline"><code id="f2217f03b1b5f1dba9b87ab670009370">[program:blogd]
command=node node_modules/bin/blogd

directory=/srv/my_project

autostart=true
autorestart=true
startretries=20
numprocs=1
stdout_logfile=/var/log/blogd.log
redirect_stderr=true</code></pre>
<p>Après redémarrage de supervisor (<code class="code-inline" id="5da9f0106c3ef53be3458314b5d0c56d">/etc/init.d/supervisor restart</code>) nous pouvons ensuite vérifier le bon fonctionnement du/des service(s) via le client :</p>
<pre class="code-multiline"><code id="534d42e3b4580903a065afd854ceab27">elao@bismuth:/etc/supervisor/conf.d|
⇒  supervisorctl
mailcatcher                      RUNNING    pid 7840, uptime 2 days, 4:51:46
phantomjs                        RUNNING    pid 7842, uptime 2 days, 4:51:46
blogd                            RUNNING    pid 11929, uptime 0:02:41</code></pre>
<h2 id="redemarrer-un-service">Redémarrer un service</h2>
<p>La syntaxe pour redémarrer un service est on ne peut plus simple.</p>
<pre class="code-multiline"><code id="5d2352073b3e1618a3c7fdbfb1a7cc59">supervisor&gt; restart blogd
blogd: stopped
blogd: started</code></pre>
<h2 id="parcourir-les-logs-depuis-le-client">Parcourir les logs depuis le client</h2>
<pre class="code-multiline"><code id="d042d12f0d27934aaf2cf404b5d380ef">supervisor&gt; tail -f blogd
==&gt; Press Ctrl-C to exit &lt;==
var/blog/content/posts/images/ =&gt; web/blog/medias
[ASSETS] Copying folders succeed
Assets copied
Listening on 127.0.0.1:5555
Config: /srv/site/silex/package.json
Backup file var/blog/current.json not found or unreadable
Loading fresh content
Refreshing data from source
Loading posts...
Loading users...
Loading tags...
Checking data...
Data checked status success
Copying assets
[ASSETS] from var/blog/content/posts/images/ =&gt; web/blog/medias
[ASSETS] Copying folders succeed
Assets copied
Listening on 127.0.0.1:5555
</code></pre>
<h2 id="activer-l-interface-web">Activer l'interface web</h2>
<p>Pour finir supervisor fournit également une interface web qui est activable via la section <code class="code-inline" id="9b27884b577f2c1581c4dddcdd09920e">[inet_http_server]</code> et qui permet de gérer les services de la même façon que le client en console.</p>
<p class="text-center">
![Supervisor - Interface web supervisor](images/posts/2014/supervisor_web.png)
</p>
<p>Il suffit de créer un nouveau fichier dans <code class="code-inline" id="35dd810a7ec81a0bcfadd24ef5eb125f">/etc/supervisor/conf.d</code> s'appelant par exemple <code class="code-inline" id="9942e7a7112d0f92178c8b313160b9a9">inet_http_server.conf</code> et d'y recopier le contenu suivant :</p>
<pre class="code-multiline"><code id="d81d62cf7611c17ecd48f05ac6f87e31">[inet_http_server]
port      = :9001
username  = elao
password  = boumbo</code></pre>
<p>Si vous ne souhaitez pas d'authentification il suffit de supprimer les deux lignes correspondantes.</p>
<p>Remarques, commentaires et corrections sont les bienvenus comme toujours, n'hésitez pas à proposer vos <a href="https://github.com/Elao/blog" target="_blank"><strong>PR</strong></a>.</p></body>
                        </main>
    <aside class="article-content__aside">
      <button class="kudo">
        <span class="kudo__button" aria-hidden="true"></span>
        <span class="screen-reader">Cet article m’a été utile</span>
        <span class="kudo__label" aria-hidden="true">Kudos</span>
      </button>
    </aside>
  </div>

  <div class="article-footer">
                  <div class="article-author">
          <div class="article-author__image">
            <img src="/elao_/pr/83/images/authors/gfaivre.jpg" />
          </div>
          <span class="article-author__info">
            Écrit par
            <strong>Guewen FAIVRE</strong>
          </span>
          <div class="article-author__social">
                          <a href="https://twitter.com/guewen_faivre" class="social social--small">
                <i class="icon icon--twitter" aria-hidden="true"></i>
                <span class="screen-reader">Compte twitter de Guewen FAIVRE</span>
              </a>
                                      <a href="https://github.com/gfaivre "class="social social--small">
                <i class="icon icon--github" aria-hidden="true"></i>
                <span class="screen-reader">Compte github de Guewen FAIVRE</span>
              </a>
                                      <a href="http://www.elao.com" class="social social--small">
                <i class="icon icon--website" aria-hidden="true"></i>
                <span class="screen-reader">Site personnel de Guewen FAIVRE</span>
              </a>
                      </div>
        </div>
            </div>
        </main>
                    <footer class="footer">
                <section class="footer__links">
                    <p class="h1 h1--small">
                        elao
                        <span>développe</span>
                         <span>du lien</span>
                    </p>
                    <div class="links">
                        <ul>
                            <li>
                                <a href="/elao_/pr/83/nos-services">Nos services</a>
                            </li>
                            <li>
                                <a href="/elao_/pr/83/etudes-de-cas/">Nos études de cas</a>
                            </li>
                            <li>
                                <a href="/elao_/pr/83/blog/">Blog</a>
                            </li>
                            <li>
                                <a href="/elao_/pr/83/methodo">Notre méthodologie</a>
                            </li>
                            <li>
                                <a href="/elao_/pr/83/la-tribu/">La tribu</a>
                            </li>
                            <li>
                                <a href="/elao_/pr/83/contact">Contact</a>
                            </li>
                            <li>
                                <a href="/elao_/pr/83/nos-valeurs">Nos valeurs</a>
                            </li>
                            <li>
                                                                <a href="/elao_/pr/83/recrutement/">
                                    Nous recrutons
                                                                            <span class="bullet">2</span>
                                                                    </a>
                            </li>
                        </ul>
                    </div>
                    <div class="socials">
                        <ul>
                            <li>
                                <a href="https://github.com/elao">
                                    <i class="icon icon--github"></i>
                                    Github
                                </a>
                            </li>
                            <li>
                                <a href="https://twitter.com/elao">
                                    <i class="icon icon--twitter"></i>
                                    Twitter
                                </a>
                            </li>
                            <li>
                                <a href="https://www.instagram.com/elao_agency/">
                                    <i class="icon icon--instagram"></i>
                                    Instagram
                                </a>
                            </li>
                        </ul>
                    </div>
                </section>
                <section class="footer__legals">
                    <span>© 2014/2021 - ELAO - Tous droits réservés</span>
                    <a href="/elao_/pr/83/legal">Mentions légales</a>
                    <a href="/elao_/pr/83/privacy">Protection des données</a>
                </section>
            </footer>
        </div>
                            <script src="/elao_/pr/83/build/runtime.de7de209.js"></script><script src="/elao_/pr/83/build/0.6d9790f4.js"></script><script src="/elao_/pr/83/build/app.ba54e536.js"></script>
                    </body>
</html>
