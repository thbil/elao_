<!DOCTYPE html>
<html lang="fr">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Elao_</title>

                    <!-- Open Graph / Facebook -->
             <meta property="og:title" content="Elao_" />
            <meta property="og:locale" content="fr" />
            <meta name="description" content="Elao est un atelier de co-conception d&#039;applications web et mobile sur mesure." />
            <meta property="og:description" content="Elao est un atelier de co-conception d&#039;applications web et mobile sur mesure." />
            <link rel="canonical" href="https://elao.github.io/elao_/pr/35/blog/dev/the-browserdetectorbundle-working-with-the-kernel-events" />
            <meta property="og:url" content="https://elao.github.io/elao_/pr/35/blog/dev/the-browserdetectorbundle-working-with-the-kernel-events" />
            <meta property="og:site_name" content="elao_" />
            
            <!-- Twitter -->
            <meta property="twitter:card" content="summary">
            <meta property="twitter:title" content="Elao_">
            <meta property="twitter:description" content="Elao est un atelier de co-conception d&#039;applications web et mobile sur mesure.">
            <meta property="twitter:site" content="@tom32i">
            <meta property="twitter:creator" content="@tom32i">
                    
                    <link rel="stylesheet" href="/elao_/pr/35/build/style.cabec594.css">
            </head>
    <body>
        <header class="header">
            <div class="container">
                                    <!--
                        Todo :
                        - only on homepage : on scroll .logo.logo--animated becomes .logo.logo--animated.logo--active (triggers its animation)
                     -->
                    <a href="/elao_/pr/35/">
                        <span class="screen-reader">Elao_</span>
                                                    <svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" viewBox="0 0 300 100" class="logo logo--animated">
                                <path d="M61.6,61.6H19.7C21,69,24.8,72.2,32.6,72.2c5.9,0,8.8-1.9,11.7-7.8l16.1,6.9C56.2,82,46.9,87.8,32.1,87.8
                                    c-19.1,0-32-12.6-32-31.6c0-19.5,12.6-32.6,31.4-32.6c18.1,0,30.3,12.6,30.3,31.6C61.7,57.2,61.7,58.9,61.6,61.6z M19.6,49.3h23.6
                                    c-0.2-7.9-4.1-10.9-11.3-10.9S20.7,41.8,19.6,49.3z"/>
                                <path d="M71.2,0.1H90v86.5H71.2V0.1z"/>
                                <path d="M166.1,24.7v61.8h-18.8V72.7c-3.5,9.8-10.5,15.1-20.4,15.1c-17.7,0-27.4-12.9-27.4-32
                                    c0-19.4,9.3-32.2,26.2-32.2c10.5,0,18,5.4,21.6,15.6V24.7H166.1z M147.9,55.7c0-10.4-4.8-15.2-15.1-15.2c-9.9,0-14.6,4.8-14.6,15.2
                                    c0,10.1,4.7,14.9,14.6,14.9C143.1,70.7,147.9,65.9,147.9,55.7L147.9,55.7z"/>
                                <path d="M242.8,55.8c0,19.9-15.3,32-33.6,32s-33.6-12.1-33.6-32s15.3-32.2,33.6-32.2S242.8,35.8,242.8,55.8z M224,55.8
                                    c0-10.4-4.7-15.2-14.8-15.2c-10.1,0-14.8,4.8-14.8,15.2c0,10.1,4.7,14.9,14.8,14.9S224,65.9,224,55.8L224,55.8z"/>
                                <rect x="243.1" y="86.5" width="56.7" height="15"/>
                            </svg>
                                            </a>
                
                
                                    <!--
                        Todo :
                        - open / close mobile nav on click on .nav-toggle buttons
                        - when mobile nav is open, .body is .body.no-scroll to prevent background scroll
                     -->
                    <!-- Desktop nav -->
                    <nav class="nav">
                        <ul>
                                                            <li class="nav__item">
                                    <a href="/elao_/pr/35/nos-services">
                                                                                <span>Nos services</span>
                                    </a>
                                </li>
                                                            <li class="nav__item">
                                    <a href="/elao_/pr/35/methodo">
                                                                                <span>Notre méthodologie</span>
                                    </a>
                                </li>
                                                            <li class="nav__item">
                                    <a href="/elao_/pr/35/nos-valeurs">
                                                                                <span>Nos valeurs</span>
                                    </a>
                                </li>
                                                            <li class="nav__item">
                                    <a href="/elao_/pr/35/la-tribu/">
                                                                                <span>La tribu</span>
                                    </a>
                                </li>
                                                            <li class="nav__item">
                                    <a href="/elao_/pr/35/blog/">
                                                                                <span>Blog</span>
                                    </a>
                                </li>
                                                            <li class="nav__item">
                                    <a href="/elao_/pr/35/contact">
                                                                                    <i class="icon icon--contact" aria-hidden="true"></i>
                                                                                <span>Contact</span>
                                    </a>
                                </li>
                                                    </ul>
                    </nav>
                
                                    <!-- Mobile nav -->
                    <nav class="nav-mobile">                        <div class="nav-mobile__header">
                            <a href="/elao_/pr/35/">
                                                            <svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" viewBox="0 0 300 100" class="logo logo--animated">
                                <path d="M61.6,61.6H19.7C21,69,24.8,72.2,32.6,72.2c5.9,0,8.8-1.9,11.7-7.8l16.1,6.9C56.2,82,46.9,87.8,32.1,87.8
                                    c-19.1,0-32-12.6-32-31.6c0-19.5,12.6-32.6,31.4-32.6c18.1,0,30.3,12.6,30.3,31.6C61.7,57.2,61.7,58.9,61.6,61.6z M19.6,49.3h23.6
                                    c-0.2-7.9-4.1-10.9-11.3-10.9S20.7,41.8,19.6,49.3z"/>
                                <path d="M71.2,0.1H90v86.5H71.2V0.1z"/>
                                <path d="M166.1,24.7v61.8h-18.8V72.7c-3.5,9.8-10.5,15.1-20.4,15.1c-17.7,0-27.4-12.9-27.4-32
                                    c0-19.4,9.3-32.2,26.2-32.2c10.5,0,18,5.4,21.6,15.6V24.7H166.1z M147.9,55.7c0-10.4-4.8-15.2-15.1-15.2c-9.9,0-14.6,4.8-14.6,15.2
                                    c0,10.1,4.7,14.9,14.6,14.9C143.1,70.7,147.9,65.9,147.9,55.7L147.9,55.7z"/>
                                <path d="M242.8,55.8c0,19.9-15.3,32-33.6,32s-33.6-12.1-33.6-32s15.3-32.2,33.6-32.2S242.8,35.8,242.8,55.8z M224,55.8
                                    c0-10.4-4.7-15.2-14.8-15.2c-10.1,0-14.8,4.8-14.8,15.2c0,10.1,4.7,14.9,14.8,14.9S224,65.9,224,55.8L224,55.8z"/>
                                <rect x="243.1" y="86.5" width="56.7" height="15"/>
                            </svg>
                        
                            </a>
                            <button class="nav-toggle nav-toggle--close">
                                <i class="icon icon--close" aria-hidden="true"></i>
                                <span class="screen-reader">Fermer le menu</span>
                            </button>
                        </div>
                        <ul>
                                                            <li class="nav-mobile__item ">
                                    <a href="/elao_/pr/35/nos-services">
                                                                                <span>Nos services</span>
                                    </a>
                                </li>
                                                            <li class="nav-mobile__item ">
                                    <a href="/elao_/pr/35/methodo">
                                                                                <span>Notre méthodologie</span>
                                    </a>
                                </li>
                                                            <li class="nav-mobile__item ">
                                    <a href="/elao_/pr/35/etudes-de-cas/">
                                                                                <span>Nos études de cas</span>
                                    </a>
                                </li>
                                                            <li class="nav-mobile__item ">
                                    <a href="/elao_/pr/35/nos-valeurs">
                                                                                <span>Nos valeurs</span>
                                    </a>
                                </li>
                                                            <li class="nav-mobile__item ">
                                    <a href="/elao_/pr/35/la-tribu/">
                                                                                <span>La tribu</span>
                                    </a>
                                </li>
                                                            <li class="nav-mobile__item ">
                                    <a href="/elao_/pr/35/blog/">
                                                                                <span>Blog</span>
                                    </a>
                                </li>
                                                            <li class="nav-mobile__item nav-mobile__item--large">
                                    <a href="/elao_/pr/35/contact">
                                                                                    <i class="icon icon--contact" aria-hidden="true"></i>
                                                                                <span>Contact</span>
                                    </a>
                                </li>
                                                    </ul>
                    </nav>
                    <button class="nav-toggle nav-toggle--open">
                        <i class="icon icon--hamburger" aria-hidden="true"></i>
                        <span class="screen-reader">Ouvrir le menu</span>
                    </button>
                            </div>
        </header>
        <div class="container">
        <main>
              <ul class="breadcrumb">
    <li class="breadcrumb__item">
      <a href="#">Blog</a>
    </li>
    <li class="breadcrumb__item">
      <a href="#">Comprendre le cache du client Graphql Apollo</a>
    </li>
  </ul>

  <div class="article-banner">
    <div class="article-banner__cover" style="background: #f1f1f1 url(/elao_/pr/35/images/posts/thumbnails/homer.jpg)"></div>

    <div class="article-info">
      <!-- todo : this is if the article has a single author -->
      <div class="article-author">
        <div class="article-author__image">
          <img src="/elao_/pr/35/images/authors/tbessoussa.jpg" />
        </div>
        <span class="article-author__info">Écrit par <strong>Tristan BESSOUSSA</strong></span>
      </div>
      <!-- todo : this is if the article has multiple authors -->
      <div class="article-author article-author--multi">
        <div class="article-author__image">
          <img src="/elao_/pr/35/images/authors/tbessoussa.jpg" />
          <img src="/elao_/pr/35/images/authors/tbessoussa.jpg" />
          <img src="/elao_/pr/35/images/authors/tbessoussa.jpg" />
        </div>
        <span class="article-author__info">
          Écrit par
          <strong>Anne-Laure DE BOISSIEU</strong>
          <strong>Tristan BESSOUSSA</strong>
          <strong>Tristan BESSOUSSA</strong>
        </span>
      </div>
      <!-- todo : if the article has more than 5 co-authors (too long, won't fit) , "la team elao" is the author -->
      <div class="article-author">
        <div class="article-author__image">
          <img src="/elao_/pr/35/images/authors/tbessoussa.jpg" />
        </div>
        <span class="article-author__info">Écrit par <strong>La team elao</strong></span>
      </div>
      <div class="article-info__date">
        <span>Publication <strong>2 août 2013</strong></span>
        <span>Modification <strong>24 septembre 2020</strong></span>
      </div>
    </div>

    <div class="article-header">
      <h1>The BrowserDetectorBundle: working with the Kernel events</h1>
      <p>The BrowserDetectorBundle: working with the Kernel events</p>
      <ul class="article-tag-list">
                  <li class="article-tag-list__item">
            <a href="/elao_/pr/35/blog/tag/Symfony">#Symfony</a>
          </li>
                  <li class="article-tag-list__item">
            <a href="/elao_/pr/35/blog/tag/PHP">#PHP</a>
          </li>
                  <li class="article-tag-list__item">
            <a href="/elao_/pr/35/blog/tag/Kernel">#Kernel</a>
          </li>
                  <li class="article-tag-list__item">
            <a href="/elao_/pr/35/blog/tag/Browser">#Browser</a>
          </li>
              </ul>
    </div>
  </div>

  <ul class="table-of-content">
    <li class="table-of-content__item">
      <a href="#intro">Introduction</a>
    </li>
    <li class="table-of-content__item">
      <a href="#quas">Quas odio atque</a>
    </li>
    <li class="table-of-content__item">
      <a href="voluptatem">Voluptatem et amet atque</a>
    </li>
  </ul>

  <div class="article-content">
    <main class="article-content__main">
      <body><p>A quoi sert l'évènement kernel.terminate ? Regardons du côté de la documentation :</p>
<blockquote>
<p>"To perform some "heavy" action after the response has been streamed to the user".</p>
</blockquote>
<p>Une question que vous vous posez surement si vous n'avez pas eu l'occasion de travailler avec cet évènement : "Quand est-ce que je peux utiliser l'évènement "kernel.terminate" pour effectuer mes traitements ?" La réponse en image :</p>
<p class="text-center">
    {{}}
</p>
<p>Concrètement, vous pouvez quasiment tout faire si vous utilisez cet évènement. A une chose près : votre traitement ne doit pas altérer la réponse. Pourquoi ? Parce qu'il est déclenché après que la réponse soit envoyé au client. Il n'y à donc plus moyen d'y rajouter des informations ou d'en altérer son contenu dans le but de l'envoyer au client. (Attention kernel.terminate a été rajouté en Symfony2.1, donc si vous êtes encore en 2.0, vous pouvez oublier).</p>
<pre class="code-multiline language-php"><code class="language-php" id="9f38d0d538e22c26e01879f248968dc1"><span class="token comment">// ...</span>
<span class="token variable">$response</span> <span class="token operator">=</span> <span class="token variable">$kernel</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">handle</span><span class="token punctuation">(</span><span class="token variable">$request</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$response</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$kernel</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">terminate</span><span class="token punctuation">(</span><span class="token variable">$request</span><span class="token punctuation">,</span> <span class="token variable">$response</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>Alors finalement comment le mettre en place ? Voilà un exemple de la classe <em>GuzzleExceptionListener</em> qui écoute 2 évènements.</p>
<pre class="code-multiline language-php"><code class="language-php" id="9720f57e11cc9496fd6b08cf3410901c"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">namespace</span> <span class="token package">Tristanbes<span class="token punctuation">\</span>ElophantBundle<span class="token punctuation">\</span>EventListener</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">Guzzle<span class="token punctuation">\</span>Http<span class="token punctuation">\</span>Exception<span class="token punctuation">\</span>BadResponseException</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Symfony<span class="token punctuation">\</span>Component<span class="token punctuation">\</span>HttpFoundation<span class="token punctuation">\</span>JsonResponse</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Symfony<span class="token punctuation">\</span>Component<span class="token punctuation">\</span>HttpKernel<span class="token punctuation">\</span>Event<span class="token punctuation">\</span>GetResponseForExceptionEvent</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">Tristanbes<span class="token punctuation">\</span>ElophantBundle<span class="token punctuation">\</span>Manager<span class="token punctuation">\</span>StatsManager</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * Class GuzzleExceptionListener
 */</span>
<span class="token keyword">class</span> <span class="token class-name">GuzzleExceptionListener</span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token variable">$statsManager</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token variable">$fail</span> <span class="token operator">=</span> <span class="token boolean constant">false</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * Constructor
     *
     * <span class="token keyword">@param</span> <span class="token class-name">StatsManager</span> <span class="token parameter">$manager</span> The stats Manager
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span>StatsManager <span class="token variable">$manager</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token this">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">statsManager</span> <span class="token operator">=</span> <span class="token variable">$manager</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">onKernelException</span><span class="token punctuation">(</span>GetResponseForExceptionEvent <span class="token variable">$event</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$exception</span> <span class="token operator">=</span> <span class="token variable">$event</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$exception</span> <span class="token keyword">instanceof</span> <span class="token class-name">BadResponseException</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token this">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">fail</span> <span class="token operator">=</span> <span class="token boolean constant">true</span><span class="token punctuation">;</span>
            <span class="token variable">$response</span>   <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JsonResponse</span><span class="token punctuation">(</span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'success'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token boolean constant">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token variable">$event</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">setResponse</span><span class="token punctuation">(</span><span class="token variable">$response</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">onKernelTerminate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean constant">false</span> <span class="token operator">===</span> <span class="token this">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">fail</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token this">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">statsManager</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">addFail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></span></code></pre>
<pre class="code-multiline language-xml"><code class="language-xml" id="589b618dcac8d7768916b76a1dbbd2d8"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>service</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>tristanbes_elophant.guzzle_exception_eventlistener<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>%tristanbes_elophant.guzzle.exception.class%<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tag</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>kernel.event_listener<span class="token punctuation">"</span></span> <span class="token attr-name">event</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>kernel.exception<span class="token punctuation">"</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>onKernelException<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>;
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tag</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>kernel.event_listener<span class="token punctuation">"</span></span> <span class="token attr-name">event</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>kernel.terminate<span class="token punctuation">"</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>onKernelTerminate<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>;
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>argument</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>service<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>tristanbes_elophant.stats.manager<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>;
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>service</span><span class="token punctuation">&gt;</span></span>;</code></pre>
<p><strong> Explications : </strong></p>
<p>Le premier évènement écouté est, <em>kernel.exception. </em>Ce dernier, lorsqu'il sera déclenché, appellera la méthode <em>onKernelException</em> de la classe <em>GuzzleExceptionListener</em> introspectera la classe de l'exception et regardera si celle ci provient d'une erreur renvoyée par Guzzle à la suite d'un appel à un WebService.</p>
<p>Si c'est le cas, elle modifiera un attribut nommé $fail et renverra une réponse en <em>json au client.</em></p>
<p>Une fois cette réponse envoyée, Symfony va [via la méthode $kernel-&gt;terminate()]; déclencher l'évènement kernel.terminate. Ce qui tombe plutôt bien car notre classe écoute cet évènement aussi. Si jamais $fail renvoie true, le service StatsManager s'occupera d'incrémenter une valeur en base de données (afin de savoir combien de requêtes ont échouées par jour).</p>
<p>Ici, on est loin de gagner des secondes sur la réponse, en effet, incrémenter une valeur en base de données est loin d'être une opération "lourde", alors pourquoi passer par kernel.terminate ? Parce qu'on peut, alors pourquoi se priver même pour de la "micro" optim ?</p>
<p>Attention cependant à bien débugger votre code, car vous ne verrez aucun output étant donné que la réponse est déjà envoyée.</p>
<p>A savoir que vous pouvez aussi ajoutez un listener directement depuis le dispatcher de Symfony2. Voilà un example avec l'utilisation d'une closure :</p>
<pre class="code-multiline language-php"><code class="language-php" id="dc677b66d9ce94da284e481910dee4bb"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">namespace</span> <span class="token package">Tristanbes<span class="token punctuation">\</span>ElophantBundle<span class="token punctuation">\</span>EventListener</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">Guzzle<span class="token punctuation">\</span>Http<span class="token punctuation">\</span>Exception<span class="token punctuation">\</span>BadResponseException</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Symfony<span class="token punctuation">\</span>Component<span class="token punctuation">\</span>HttpFoundation<span class="token punctuation">\</span>JsonResponse</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Symfony<span class="token punctuation">\</span>Component<span class="token punctuation">\</span>EventDispatcher<span class="token punctuation">\</span>EventDispatcher</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Symfony<span class="token punctuation">\</span>Component<span class="token punctuation">\</span>HttpKernel<span class="token punctuation">\</span>Event<span class="token punctuation">\</span>GetResponseForExceptionEvent</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">Tristanbes<span class="token punctuation">\</span>ElophantBundle<span class="token punctuation">\</span>Manager<span class="token punctuation">\</span>StatsManager</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * Class GuzzleExceptionListener
 */</span>
<span class="token keyword">class</span> <span class="token class-name">GuzzleExceptionListener</span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token variable">$statsManager</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token variable">$dispatcher</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token variable">$fail</span> <span class="token operator">=</span> <span class="token boolean constant">false</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * Constructor
     *
     * <span class="token keyword">@param</span> <span class="token class-name">StatsManager</span> <span class="token parameter">$manager</span> The stats Manager
     * <span class="token keyword">@param</span>
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span>StatsManager <span class="token variable">$manager</span><span class="token punctuation">,</span> EventDispatcher <span class="token variable">$dispatcher</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token this">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">statsManager</span> <span class="token operator">=</span> <span class="token variable">$manager</span><span class="token punctuation">;</span>
        <span class="token this">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">dispatcher</span>   <span class="token operator">=</span> <span class="token variable">$dispatcher</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">onKernelException</span><span class="token punctuation">(</span>GetResponseForExceptionEvent <span class="token variable">$event</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$exception</span> <span class="token operator">=</span> <span class="token variable">$event</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$statsManager</span> <span class="token operator">=</span> <span class="token this">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">statsManager</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$exception</span> <span class="token keyword">instanceof</span> <span class="token class-name">BadResponseException</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token this">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">dispatcher</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'kernel.terminate'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>Event <span class="token variable">$event</span><span class="token punctuation">)</span> <span class="token keyword">use</span> <span class="token punctuation">(</span><span class="token variable">$statsManager</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token variable">$statsManager</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">addFail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></span></code></pre>
<pre class="code-multiline language-xml"><code class="language-xml" id="77123c4532b39418eb580d13d3869b44"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>service</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>tristanbes_elophant.guzzle_exception_eventlistener<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>%tristanbes_elophant.guzzle.exception.class%<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>;
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tag</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>kernel.event_listener<span class="token punctuation">"</span></span> <span class="token attr-name">event</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>kernel.exception<span class="token punctuation">"</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>onKernelException<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>;
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>argument</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>service<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>tristanbes_elophant.stats.manager<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>;
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>argument</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>service<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>event_dispatcher<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>;
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>service</span><span class="token punctuation">&gt;</span></span></code></pre></body>
    </main>
    <aside class="article-content__aside">
      <button class="kudo">
        <span class="kudo__button" aria-hidden="true"></span>
        <span class="screen-reader">Cet article m’a été utile</span>
        <span class="kudo__label" aria-hidden="true">Kudos</span>
      </button>
    </aside>
  </div>

  <div class="article-footer">
    <!-- If the article has one single author -->
    <div class="article-author">
      <div class="article-author__image">
        <img src="/elao_/pr/35/images/authors/tbessoussa.jpg" />
      </div>
      <span class="article-author__info">Écrit par<strong>Tristan BESSOUSSA</strong></span>
      <div class="article-author__social">
                  <a href=sf_tristanb class="social social--small">
            <i class="icon icon--twitter" aria-hidden="true"></i>
            <span class="screen-reader">Compte twitter de Tristan BESSOUSSA</span>
          </a>
                          <a href=tristanbes class="social social--small">
            <i class="icon icon--github" aria-hidden="true"></i>
            <span class="screen-reader">Compte github de Tristan BESSOUSSA</span>
          </a>
                          <a href=http://www.elao.com class="social social--small">
            <i class="icon icon--website" aria-hidden="true"></i>
            <span class="screen-reader">Site personnel de Tristan BESSOUSSA</span>
          </a>
              </div>
    </div>
    <!-- If the article has mutltiple authors -->
    <div class="article-author">
      <div class="article-author__image">
        <img src="/elao_/pr/35/images/authors/tbessoussa.jpg" />
      </div>
      <span class="article-author__info">Co-auteur<strong>Tristan BESSOUSSA</strong></span>
      <div class="article-author__social">
                  <a href=sf_tristanb class="social social--small">
            <i class="icon icon--twitter" aria-hidden="true"></i>
            <span class="screen-reader">Compte twitter de Tristan BESSOUSSA</span>
          </a>
                          <a href=tristanbes class="social social--small">
            <i class="icon icon--github" aria-hidden="true"></i>
            <span class="screen-reader">Compte github de Tristan BESSOUSSA</span>
          </a>
                          <a href=http://www.elao.com class="social social--small">
            <i class="icon icon--website" aria-hidden="true"></i>
            <span class="screen-reader">Site personnel de Tristan BESSOUSSA</span>
          </a>
              </div>
    </div>
    <div class="article-author">
      <div class="article-author__image">
        <img src="/elao_/pr/35/images/authors/tbessoussa.jpg" />
      </div>
      <span class="article-author__info">Co-auteur<strong>Tristan BESSOUSSA</strong></span>
      <div class="article-author__social">
                  <a href=sf_tristanb class="social social--small">
            <i class="icon icon--twitter" aria-hidden="true"></i>
            <span class="screen-reader">Compte twitter de Tristan BESSOUSSA</span>
          </a>
                          <a href=tristanbes class="social social--small">
            <i class="icon icon--github" aria-hidden="true"></i>
            <span class="screen-reader">Compte github de Tristan BESSOUSSA</span>
          </a>
                          <a href=http://www.elao.com class="social social--small">
            <i class="icon icon--website" aria-hidden="true"></i>
            <span class="screen-reader">Site personnel de Tristan BESSOUSSA</span>
          </a>
              </div>
    </div>
  </div>

  
        </main>
                    <footer class="footer">
                <section class="footer__links">
                    <p class="h1 h1--small">
                        elao
                        <span>développe</span>
                         <span>du lien</span>
                    </p>
                    <div class="links">
                        <ul>
                            <li>
                                <a href="#">Nos services</a>
                            </li>
                            <li>
                                <a href="#">Nos études de cas</a>
                            </li>
                            <li>
                                <a href="#">Blog</a>
                            </li>
                            <li>
                                <a href="#">Notre méthodologie</a>
                            </li>
                            <li>
                                <a href="#">La tribu</a>
                            </li>
                            <li>
                                <a href="#">Contact</a>
                            </li>
                            <li>
                                <a href="#">Nos valeurs</a>
                            </li>
                            <li>
                                <a href="#">Nous recrutons <span class="bullet">3</span></a>
                            </li>
                        </ul>
                    </div>
                    <div class="socials">
                        <ul>
                            <li>
                                <a href="#">
                                    <i class="icon icon--github"></i>
                                    Github
                                </a>
                            </li>
                            <li>
                                <a href="#">
                                    <i class="icon icon--twitter"></i>
                                    Twitter
                                </a>
                            </li>
                            <li>
                                <a href="#">
                                    <i class="icon icon--instagram"></i>
                                    Instagram
                                </a>
                            </li>
                        </ul>
                    </div>
                </section>
                <section class="footer__legals">
                    <span>© 2014/2020 - ELAO - Tous droits réservés</span>
                    <a href="#">Mentions légales</a>
                    <a href="#">Protection des données</a>
                </section>
            </footer>
        </div>
                            <script src="/elao_/pr/35/build/runtime.27a2bcc8.js"></script><script src="/elao_/pr/35/build/app.a7244376.js"></script>
                    </body>
</html>
