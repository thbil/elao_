<!DOCTYPE html>
<html lang="fr">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Elao_</title>

                    <!-- Open Graph / Facebook -->
             <meta property="og:title" content="Elao_" />
            <meta property="og:locale" content="fr" />
            <meta name="description" content="Elao est un atelier de co-conception d&#039;applications web et mobile sur mesure." />
            <meta property="og:description" content="Elao est un atelier de co-conception d&#039;applications web et mobile sur mesure." />
            <link rel="canonical" href="https://elao.github.io/elao_/pr/42/blog/dev/ameliorez-pertinence-resultat-elastic-search-score" />
            <meta property="og:url" content="https://elao.github.io/elao_/pr/42/blog/dev/ameliorez-pertinence-resultat-elastic-search-score" />
            <meta property="og:site_name" content="elao_" />
            
            <!-- Twitter -->
            <meta property="twitter:card" content="summary">
            <meta property="twitter:title" content="Elao_">
            <meta property="twitter:description" content="Elao est un atelier de co-conception d&#039;applications web et mobile sur mesure.">
            <meta property="twitter:site" content="@tom32i">
            <meta property="twitter:creator" content="@tom32i">
                    
                    <link rel="stylesheet" href="/elao_/pr/42/build/style.303f0a03.css">
            </head>
    <body>
        <header class="header">
            <div class="container">
                                    <!--
                        Todo :
                        - only on homepage : on scroll .logo.logo--animated becomes .logo.logo--animated.logo--active (triggers its animation)
                     -->
                    <a href="/elao_/pr/42/">
                        <span class="screen-reader">Elao_</span>
                                                    <svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" viewBox="0 0 300 100" class="logo logo--animated">
                                <path d="M61.6,61.6H19.7C21,69,24.8,72.2,32.6,72.2c5.9,0,8.8-1.9,11.7-7.8l16.1,6.9C56.2,82,46.9,87.8,32.1,87.8
                                    c-19.1,0-32-12.6-32-31.6c0-19.5,12.6-32.6,31.4-32.6c18.1,0,30.3,12.6,30.3,31.6C61.7,57.2,61.7,58.9,61.6,61.6z M19.6,49.3h23.6
                                    c-0.2-7.9-4.1-10.9-11.3-10.9S20.7,41.8,19.6,49.3z"/>
                                <path d="M71.2,0.1H90v86.5H71.2V0.1z"/>
                                <path d="M166.1,24.7v61.8h-18.8V72.7c-3.5,9.8-10.5,15.1-20.4,15.1c-17.7,0-27.4-12.9-27.4-32
                                    c0-19.4,9.3-32.2,26.2-32.2c10.5,0,18,5.4,21.6,15.6V24.7H166.1z M147.9,55.7c0-10.4-4.8-15.2-15.1-15.2c-9.9,0-14.6,4.8-14.6,15.2
                                    c0,10.1,4.7,14.9,14.6,14.9C143.1,70.7,147.9,65.9,147.9,55.7L147.9,55.7z"/>
                                <path d="M242.8,55.8c0,19.9-15.3,32-33.6,32s-33.6-12.1-33.6-32s15.3-32.2,33.6-32.2S242.8,35.8,242.8,55.8z M224,55.8
                                    c0-10.4-4.7-15.2-14.8-15.2c-10.1,0-14.8,4.8-14.8,15.2c0,10.1,4.7,14.9,14.8,14.9S224,65.9,224,55.8L224,55.8z"/>
                                <rect x="243.1" y="86.5" width="56.7" height="15"/>
                            </svg>
                                            </a>
                
                
                                    <!--
                        Todo :
                        - open / close mobile nav on click on .nav-toggle buttons
                        - when mobile nav is open, .body is .body.no-scroll to prevent background scroll
                     -->
                    <!-- Desktop nav -->
                    <nav class="nav">
                        <ul>
                                                            <li class="nav__item">
                                    <a href="/elao_/pr/42/nos-services">
                                                                                <span>Nos services</span>
                                    </a>
                                </li>
                                                            <li class="nav__item">
                                    <a href="/elao_/pr/42/methodo">
                                                                                <span>Notre méthodologie</span>
                                    </a>
                                </li>
                                                            <li class="nav__item">
                                    <a href="/elao_/pr/42/nos-valeurs">
                                                                                <span>Nos valeurs</span>
                                    </a>
                                </li>
                                                            <li class="nav__item">
                                    <a href="/elao_/pr/42/la-tribu/">
                                                                                <span>La tribu</span>
                                    </a>
                                </li>
                                                            <li class="nav__item">
                                    <a href="/elao_/pr/42/blog/">
                                                                                <span>Blog</span>
                                    </a>
                                </li>
                                                            <li class="nav__item">
                                    <a href="/elao_/pr/42/contact">
                                                                                    <i class="icon icon--contact" aria-hidden="true"></i>
                                                                                <span>Contact</span>
                                    </a>
                                </li>
                                                    </ul>
                    </nav>
                
                                    <!-- Mobile nav -->
                    <nav class="nav-mobile">
                        <div class="nav-mobile__header">
                            <a href="/elao_/pr/42/">
                                                            <svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" viewBox="0 0 300 100" class="logo logo--animated">
                                <path d="M61.6,61.6H19.7C21,69,24.8,72.2,32.6,72.2c5.9,0,8.8-1.9,11.7-7.8l16.1,6.9C56.2,82,46.9,87.8,32.1,87.8
                                    c-19.1,0-32-12.6-32-31.6c0-19.5,12.6-32.6,31.4-32.6c18.1,0,30.3,12.6,30.3,31.6C61.7,57.2,61.7,58.9,61.6,61.6z M19.6,49.3h23.6
                                    c-0.2-7.9-4.1-10.9-11.3-10.9S20.7,41.8,19.6,49.3z"/>
                                <path d="M71.2,0.1H90v86.5H71.2V0.1z"/>
                                <path d="M166.1,24.7v61.8h-18.8V72.7c-3.5,9.8-10.5,15.1-20.4,15.1c-17.7,0-27.4-12.9-27.4-32
                                    c0-19.4,9.3-32.2,26.2-32.2c10.5,0,18,5.4,21.6,15.6V24.7H166.1z M147.9,55.7c0-10.4-4.8-15.2-15.1-15.2c-9.9,0-14.6,4.8-14.6,15.2
                                    c0,10.1,4.7,14.9,14.6,14.9C143.1,70.7,147.9,65.9,147.9,55.7L147.9,55.7z"/>
                                <path d="M242.8,55.8c0,19.9-15.3,32-33.6,32s-33.6-12.1-33.6-32s15.3-32.2,33.6-32.2S242.8,35.8,242.8,55.8z M224,55.8
                                    c0-10.4-4.7-15.2-14.8-15.2c-10.1,0-14.8,4.8-14.8,15.2c0,10.1,4.7,14.9,14.8,14.9S224,65.9,224,55.8L224,55.8z"/>
                                <rect x="243.1" y="86.5" width="56.7" height="15"/>
                            </svg>
                        
                            </a>
                            <button class="nav-toggle nav-toggle--close">
                                <i class="icon icon--close" aria-hidden="true"></i>
                                <span class="screen-reader">Fermer le menu</span>
                            </button>
                        </div>
                        <ul>
                                                            <li class="nav-mobile__item">
                                    <a href="/elao_/pr/42/nos-services">
                                                                                <span>Nos services</span>
                                    </a>
                                </li>
                                                            <li class="nav-mobile__item">
                                    <a href="/elao_/pr/42/methodo">
                                                                                <span>Notre méthodologie</span>
                                    </a>
                                </li>
                                                            <li class="nav-mobile__item">
                                    <a href="/elao_/pr/42/etudes-de-cas/">
                                                                                <span>Nos études de cas</span>
                                    </a>
                                </li>
                                                            <li class="nav-mobile__item">
                                    <a href="/elao_/pr/42/nos-valeurs">
                                                                                <span>Nos valeurs</span>
                                    </a>
                                </li>
                                                            <li class="nav-mobile__item">
                                    <a href="/elao_/pr/42/la-tribu/">
                                                                                <span>La tribu</span>
                                    </a>
                                </li>
                                                            <li class="nav-mobile__item">
                                    <a href="/elao_/pr/42/blog/">
                                                                                <span>Blog</span>
                                    </a>
                                </li>
                                                            <li class="nav-mobile__item">
                                    <a href="/elao_/pr/42/contact">
                                                                                    <i class="icon icon--contact" aria-hidden="true"></i>
                                                                                <span>Contact</span>
                                    </a>
                                </li>
                                                    </ul>
                    </nav>
                    <button class="nav-toggle nav-toggle--open">
                        <i class="icon icon--hamburger" aria-hidden="true"></i>
                        <span class="screen-reader">Ouvrir le menu</span>
                    </button>
                            </div>
        </header>
        <div class="container">
        <main>
              <img src="/elao_/pr/42/images/posts/thumbnails/elasticsearch.png" />

  <div>
    <img src="/elao_/pr/42/images/authors/mcolin.jpg" />
    <p>Écrit par Maxime COLIN<p>
    <p>Publication 27 avril 2017<p>
    <p>Modification 21 septembre 2020<p>
  </div>

  <div>
          <a href="/elao_/pr/42/blog/tag/moteur%20de%20recherche">#moteur de recherche</a>
          <a href="/elao_/pr/42/blog/tag/recherche">#recherche</a>
          <a href="/elao_/pr/42/blog/tag/elasticsearch">#elasticsearch</a>
          <a href="/elao_/pr/42/blog/tag/pertinence">#pertinence</a>
          <a href="/elao_/pr/42/blog/tag/score">#score</a>
          <a href="/elao_/pr/42/blog/tag/ES">#ES</a>
          <a href="/elao_/pr/42/blog/tag/elastica">#elastica</a>
      </div>

  <div>
    <h1>Améliorez la pertinence de vos résultats ElasticSearch grâce au score</h1>
    <p>Améliorez la pertinence de vos résultats ElasticSearch grâce au score.</p>
  </div>

  <div>
    <body><h2 id="elasticsearch">ElasticSearch<a href="#elasticsearch" class="anchor"></a></h2>
<p><a href="https://www.elastic.co/fr/products/elasticsearch" target="_blank">ElasticSearch</a> est un moteur de recherche très puissant mais relativement simple à mettre en place et à intégrer grâce à son API RESTful. Des bibliothèques telles que le client PHP <a href="http://elastica.io/" target="_blank">Elastica</a> et le bundle Symfony <a href="https://github.com/FriendsOfSymfony/FOSElasticaBundle" target="_blank">FOSElasticaBundle</a> facilitent encore plus son intégration. Néanmoins la configuration fine du moteur de recherche reste assez complexe et peut faire peur au premier abord.</p>
<p>Je ne vais pas parler de la configuration serveur et infrastructure d'ElasticSearch qui touche plus aux performances et à la sécurité de l'outil mais plutôt m'attarder sur la configuration du moteur de recherche en lui-même, de ce qui impactera la pertinence de vos résultats.</p>
<p>Deux choses vont impacter les résultats de vos recherches : l'<strong>indexation</strong> de vos données et vos <strong>requêtes</strong> de recherche. Ce sont donc ces deux points qui vont être abordés dans cet article.</p>
<h2 id="une-histoire-de-score">Une histoire de score<a href="#une-histoire-de-score" class="anchor"></a></h2>
<p>Lors d'une recherche ElasticSearch, un score est calculé pour chaque document du résultat. Ce score est censé représenter la pertinence du document afin de pouvoir ordonner les résultats. Néanmoins il ne représente que la pertinence des résultats face aux paramètres de la recherche et d'indexation.</p>
<p>Pour calculer ce score, ElasticSearch va s'appuyer sur trois critères :</p>
<ul><li>La <strong>fréquence du terme</strong> recherché dans le document. Plus le terme est fréquent, plus son poids sera élevé.</li>
<li>La <strong>fréquence inverse du terme</strong> à travers tous les documents. Plus le terme est fréquent, moins il aura de poids.</li>
<li>La <strong>longueur du champ</strong>. Plus le champ est grand, plus le poids sera faible ; inversement, plus le champ est petit, plus le poids sera élevé.</li>
</ul><p>Par defaut, ElasticSearch combine ces 3 règles pour obtenir un score, mais certaines peuvent être désactivées si elles ne vous semblent pas correspondre à vos données. Pour plus d'informations sur le calcul du score, lisez la <a href="https://www.elastic.co/guide/en/elasticsearch/guide/current/scoring-theory.html" target="_blank">théorie du score</a> sur le site d'ElasticSearch.</p>
<p>Ces règles permettent déjà d'avoir une bonne notion de pertinence mais restent assez simples et ne prennent pas en compte le métier de vos données. Pour ajouter plus de logique dans les scores, vous devrez introduire vos propres règles qui influenceront voire remplaceront le score.</p>
<h2 id="indexation">Indexation<a href="#indexation" class="anchor"></a></h2>
<p>L'indexation est la première étape lorsque qu'il s'agit d'optimiser la pertinence de son moteur de recherche. Car c'est grâce aux données indéxées qu'ElasticSearch va calculer les scores.</p>
<h3 id="typage">Typage<a href="#typage" class="anchor"></a></h3>
<p>ElasticSearch propose un <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping-types.html" target="_blank">large choix de types</a> pour vos données. Il a de nombreux types spéciaux qui n'existent pas dans les languages de programmation tels que <span class="inline-code">geo_point</span> ou <span class="inline-code">ip</span>. Il est important de typer correctement ses données car ElasticSearch dispose de traitements optimisés pour chaque type.</p>
<h3 id="analyser">Analyser<a href="#analyser" class="anchor"></a></h3>
<p>L'<span class="inline-code">analyser</span> est chargé d'examiner les données a indéxer afin de les stocker de la façon la plus optimale pour les recherches. Cette partie est très importante car des données mal indéxées ne permettront pas une recherche pertinente. Il faut donc choisir avec soin l'<span class="inline-code">analyser</span> pour chaque type de donnée que vous souhaitez indéxer. Ce choix est d'autant plus important pour les données complexes telles qu'un texte.</p>
<p>ElasticSearch propose <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/analysis-analyzers.html" target="_blank">plusieurs <span class="inline-code">analysers</span></a> configurables. Chaque <span class="inline-code">analyzer</span> est une combinaison d'un <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/analysis-tokenizers.html" target="_blank"><span class="inline-code">tokeniser</span></a> chargé de découper votre donnée en tokens, de <span class="inline-code">char filters</span> chargés de filtrer les caractères et de <span class="inline-code">token filters</span> chargés de filtrer les tokens.</p>
<p>Vous pouvez également <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/analysis-custom-analyzer.html" target="_blank">créer votre propre <span class="inline-code">analyzer</span></a> en combinant vous-même <span class="inline-code">tokeniser</span>, <span class="inline-code">char filters</span> et <span class="inline-code">token filters</span>. Pour configurer un moteur de recherche efficace, il est donc recommandé de choisir ou créer un <span class="inline-code">analyser</span> adapté à chacune des données indéxées.</p>
<p>Par exemple, pour obtenir une indexation efficace d'un texte, il existe quelques filtres très importants à mettre en place :</p>
<ul><li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/analysis-stemmer-tokenfilter.html#analysis-stemmer-tokenfilter" target="_blank"><span class="inline-code">stemmer</span></a> : Permet une analyse linguistique de votre texte basée sur les racines des mots dans une langue donnée (une recherche sur le mot "collection" trouvera ainsi les mots "collectionner" ou "collectionneur" par exemple).</li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/analysis-stop-tokenfilter.html" target="_blank"><span class="inline-code">stop</span></a> : Permet de filtrer les <em>stop words</em>, c'est-à-dire les mots de liaison qui ne sont pas porteurs de sens et qui ne feraient que polluer l'index (en français par exemple : "de", "en", "à", "le", "la", ...).</li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/analysis-keyword-marker-tokenfilter.html" target="_blank"><span class="inline-code">keyword_marker</span></a> : Permet d'indiquer des mots clés à considérer comme un seul token et non comme plusieurs mots (par exemple "service worker" ou "sous domaine" sont des mots clés).</li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/analysis-lowercase-tokenfilter.html" target="_blank"><span class="inline-code">lowercase</span></a> : Permet de tout indexer en <em>lowercase</em> afin de ne pas être sensible à la casse.</li>
</ul><p>Il existe bien évidemment <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/analysis-lang-analyzer.html#french-analyzer" target="_blank">des <span class="inline-code">analysers</span> par langue déjà prêts à l'emploi</a>, mais l'idée est de vous montrer qu'il est important de bien indiquer à <strong>ElasticSearch</strong> comment analyser vos données.</p>
<h3 id="boost">Boost<a href="#boost" class="anchor"></a></h3>
<p>Vous pouvez ajouter dans votre mapping des <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping-boost.html" target="_blank">boost</a> sur certaines propriétés afin de privilégier automatiquement ces propriétés lors du calcul de pertinence.</p>
<div class="tabs">
<div class="nav">
<a href="#mapping-boost-json" class="active">json</a>
<a href="#mapping-boost-yaml">yaml</a>
</div>
<div class="tab active" id="mapping-boost-json">
<code highlight="json" id="aadb47214e407b79fba4d287cf8f310c">
{
  "mappings": {
    "article": {
      "properties": {
        "title": {
          "type": "text",
          "boost": 3
        },
        "content": {
          "type": "text"
        }
      }
    }
  }
}
</code>
</div>
<div class="tab" id="mapping-boost-yaml">
<code highlight="yaml" id="4a60445c9deb2238571534f2b1c0b20f">
fos_elastica:
  indexes:
    app:
      types:
        article:
          mappings:
            title:   { analyzer: my_analyzer, boost: 3 }
            content: { analyzer: my_analyzer }
</code>
</div>
</div>
<p>Dans cet exemple, le titre aura 3 fois plus de poids que le contenu lors du calcul de pertinence.</p>
<div style="border-left: 5px solid #ffa600;padding: 20px;margin: 20px 0;">
    Attention, les `boosts` indiqués au `mapping` ne fonctionneront que sur les requêtes de type `term`. Pour les requêtes de type `range` ou `match` par exemple, il faudra préciser les `boosts` dans la requête comme expliqué dans la suite de l'article.
</div>
<h2 id="requ-ter">Requêter<a href="#requ-ter" class="anchor"></a></h2>
<h3 id="analyzer">Analyzer<a href="#analyzer" class="anchor"></a></h3>
<p>Pour utiliser votre <span class="inline-code">analyser</span> lors de la recherche, vous devez le préciser dans votre requête. Vous pouvez compléter votre requête avec les options <span class="inline-code">fuzziness</span> et <span class="inline-code">minimum_should_match</span>.</p>
<p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-minimum-should-match.html" target="_blank"><span class="inline-code">minimum_should_match</span></a> permet d'indiquer le pourcentage minimum de votre recherche qui doit être trouvé dans vos documents.</p>
<p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/common-options.html#fuzziness" target="_blank"><span class="inline-code">fuzziness</span></a> permet de rechercher des termes malgré des fautes de frappe (inversion de lettre, lettre manquante, ...) en utilisant la <a href="https://fr.wikipedia.org/wiki/Distance_de_Levenshtein" target="_blank">Distance de Levenshtein</a>.</p>
<p>Les scores des résultats seront bien évidemment impactés par ces options.</p>
<div class="tabs">
<div class="nav">
<a href="#query-analyzer-json" class="active">json</a>
<a href="#query-analyzer-php">php</a>
</div>
<div class="tab active" id="query-analyzer-json">
<code highlight="json" id="7f0e38e3693bc85dc2c928b22a4342e2">
{
  "query": {
    "bool": {
      "must": [
        { "match": {
          "title": {
            "query": "Foobar",
            "analyser": "my_analyser",
            "fuzziness": "AUTO",
            "minimum_should_match": "70%"
          }
        }}
      ]
    }
  }
}
</code>
</div>
<div class="tab" id="query-analyzer-php">
<code highlight="php" id="6ddc85eaecb6d373cd6c6e127ce5530f">
<?php use Elastica\Query;

$query = (new Query\Match())
    ->setFieldQuery('title', $search)
    -&gt;setFieldAnalyzer('title', 'my_analyzer')
    -&gt;setFieldFuzziness('title', 'AUTO')
    -&gt;setFieldMinimumShouldMatch('title', '70%')
);

</code>
</div>
</div>
<h3 id="boost">Boost<a href="#boost" class="anchor"></a></h3>
<p>Les <a href="https://www.elastic.co/guide/en/elasticsearch/guide/current/_boosting_query_clauses.html" target="_blank"><span class="inline-code">boost</span></a> permettent également d'augmenter le poids d'une clause de votre rêquete. Plus le boost est élevé, plus votre clause pèsera sur le score.</p>
<p>Dans l'exemple suivant, nous faisons une recherche de la chaine <span class="inline-code">Foobar</span> sur un document ayant un titre et un contenu. Grâce aux <span class="inline-code">boost</span> nous pouvons donner plus d'importance aux titres qu'aux contenus.</p>
<div class="tabs">
<div class="nav">
<a href="#boost-json" class="active">json</a>
<a href="#boost-php">php</a>
</div>
<div class="tab active" id="boost-json">
<code highlight="json" id="04672654d7a530987ea45a2db68fec22">
{
  "query": {
    "bool": {
      "should": [
        { "match": {
          "title": { "query": "Foobar", "boost": 5 }
        }},
        { "match": {
          "content": { "query": "Foobar", "boost": 2 }
        }}
      ]
    }
  }
}
</code>
</div>
<div class="tab" id="boost-php">
<code highlight="php" id="56ffd820b56db9ad2dbf14b51a6394df">
<?php use Elastica\Query;

$query = new Query\Bool();

$query->addShould((new Query\Match())
    -&gt;setFieldQuery('title', $search)
    -&gt;setFieldBoost('title', 5)
);

$query-&gt;addShould((new Query\Match())
    -&gt;setFieldQuery('content', $search)
    -&gt;setFieldBoost('content', 2)
);
</code>
</div>
</div>
<p>Vous pouvez également utiliser plusieurs <span class="inline-code">boost</span> sur la même propriété mais avec plusieurs valeurs afin d'augmenter le score par palier.</p>
<div class="tabs">
<div class="nav">
<a href="#boost-step-json" class="active">json</a>
<a href="#boost-step-php">php</a>
</div>
<div class="tab active" id="boost-step-json">
<code highlight="json" id="7068156bb700a0e649151a25cbae1d31">
{
  "query" : {
    "bool" : {
      "should" : [
        { "range" : {
          "publishedAt" : { "boost" : 5, "gte" : "" }
        }},
        { "range" : {
          "publishedAt" : { "boost" : 4, "gte" : "" }
        }},
        { "range" : {
          "publishedAt" : { "boost" : 3, "gte" : "" }
        }}
      ]
    }
  }
}
</code>
</div>
<div class="tab" id="boost-step-php">
<code highlight="php" id="adddd9b8955b0f4732967ba8f1a3e0a4">
<?php use Elastica\Query;

$bool = new Query\Bool();

$query->addShould((new Query\Range('publishedAt', [
    'boost' =&gt; 5,
    'gte'   =&gt; (new \DateTime('-1 month'))-&gt;format('c'),
])));

$query-&gt;addShould((new Query\Range('publishedAt', [
    'boost' =&gt; 4,
    'gte'   =&gt; (new \DateTime('-2 months'))-&gt;format('c'),
])));

$query-&gt;addShould((new Query\Range('publishedAt', [
    'boost' =&gt; 3,
    'gte'   =&gt; (new \DateTime('-3 months'))-&gt;format('c'),
])));
</code>
</div>
</div>
<h3 id="les-fonctions-de-score">Les fonctions de score<a href="#les-fonctions-de-score" class="anchor"></a></h3>
<p>Les fonctions de score permettent de modifier le score de vos résultats.</p>
<p>Il existe plusieurs types de fonctions de score :</p>
<ul><li><span class="inline-code">script_score</span></li>
<li><span class="inline-code">weight</span></li>
<li><span class="inline-code">random_score</span></li>
<li><span class="inline-code">field_value_factor</span></li>
<li><span class="inline-code">decay functions</span></li>
</ul><p>Je vais surtout détailler les fonctions <span class="inline-code">script</span> et <span class="inline-code">decay</span> car ce sont celles qui permettent le plus d'implémenter une logique de pertinence. Pour les autres vous pouvez lire <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-function-score-query.html#score-functions" target="_blank">la documentation sur les fonctions de score</a>.</p>
<h4 id="les-scripts-de-score">Les scripts de score<a href="#les-scripts-de-score" class="anchor"></a></h4>
<p>Les scripts de score (<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-function-score-query.html#function-script-score" target="_blank"><span class="inline-code">script_score</span></a>) vous permettent de modifier le score de vos résultats à partir d'un script ou d'une formule de votre choix. Vous avez accès au document dont vous modifiez le score et pouvez donc utiliser l'une de ses propriétés dans le calcul. <span class="inline-code">_score</span> est une variable qui contient le score original.</p>
<div class="tabs">
<div class="nav">
<a href="#script-functions-json" class="active">json</a>
<a href="#script-functions-php">php</a>
</div>
<div class="tab active" id="script-functions-json">
<code highlight="json" id="04b0726dbd3bccfed810fdde6261296f">
{
    "script_score" : {
        "script" : {
          "lang": "painless",
          "inline": "_score * doc['my_numeric_field'].value"
        }
    }
}
</code>
</div>
<div class="tab" id="script-functions-php">
<code highlight="php" id="e7fcd60c764c9cbfe08b0874f877b4c6">
<?php use Elastica\Query;

$bool = new Query\Bool();

$score = new Query\FunctionScore();
$score->addScriptScoreFunction(
    new \Elastica\Script("_score * doc['my_numeric_field'].value")
);

$score-&gt;setQuery($bool);

$query = new Query($score);
</code>
</div>
</div>
<p>Vous pouvez ainsi utiliser une valeur ou une formule métier pour calculer la pertinence de vos résultats.</p>
<h4 id="facteur">Facteur<a href="#facteur" class="anchor"></a></h4>
<p>Cette fonction de score (<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-function-score-query.html#function-field-value-factor" target="_blank"><span class="inline-code">field_value_factor</span></a>) vous permet d'appliquer un facteur de multiplication (<span class="inline-code">factor</span>), une valeur par defaut (<span class="inline-code">missing</span>) ainsi qu'une fonction mathématique (<span class="inline-code">modifier</span>) à une propriété de votre document. Plusieurs fonctions mathématiques sont disponibles (<span class="inline-code">log</span>, <span class="inline-code">sqrt</span>, <span class="inline-code">ln</span>, ...).</p>
<div class="tabs">
<div class="nav">
<a href="#factor-functions-json" class="active">json</a>
<a href="#factor-functions-php">php</a>
</div>
<div class="tab active" id="factor-functions-json">
<code highlight="json" id="ecf5aaa9d25f8c3fe8b012140419ef47">
{
    "field_value_factor": {
        "field": "rate",
        "factor": 1.1,
        "modifier": "sqrt",
        "missing": 1
    }
}
</code>
</div>
<div class="tab" id="factor-functions-php">
<code highlight="php" id="9958daacb636fb0f0ab6b5c150f23884">
<?php use Elastica\Query;

$bool = new Query\Bool();

$score = new Query\FunctionScore();
$score->addFieldValueFactorFunction(
    'rate',
    1.1,
    Query\FunctionScore::FIELD_VALUE_FACTOR_MODIFIER_SQRT,
    1
);

$score-&gt;setQuery($bool);

$query = new Query($score);
</code>
</div>
</div>
<p>Dans cet exemple, la pertinence d'un résultat repose sur la note du document via la formule suivante : <span class="inline-code">sqrt(1.1 * doc.rate)</span>.</p>
<h4 id="les-fonctions-de-d-croissance">Les fonctions de décroissance<a href="#les-fonctions-de-d-croissance" class="anchor"></a></h4>
<p>Les fonctions de décroissance (<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-function-score-query.html#function-decay" target="_blank"><span class="inline-code">decay function</span></a>) sont une autre méthode pour modifier le score de vos résultats. Elles se basent sur des fonctions mathématiques pour réduire le score de vos résultats.</p>
<div class="tabs">
<div class="nav">
<a href="#decay-functions-json" class="active">json</a>
<a href="#decay-functions-php">php</a>
</div>
<div class="tab active" id="decay-functions-json">
<code highlight="json" id="29bd04b7a69de43077b3fe8e180d0539">
{
    "DECAY_FUNCTION": {
        "FIELD_NAME": {
              "origin": "2017-04-24",
              "offset": "1d",
              "scale": "5d",
              "decay": 0.5
        }
    }
}
</code>
</div>
<div class="tab" id="decay-functions-php">
<code highlight="php" id="11eb5b53b9229e8f50fffaa2ba41f37c">
<?php use Elastica\Query;

$bool = new Query\Bool();

$score = new Query\FunctionScore();
$score->addDecayFunction(
    Query\FunctionScore::DECAY_LINEAR,
    'publishedAt',
    '2017-04-24',
    '5d',
    '1d',
    0.90
);

$score-&gt;setQuery($bool);

$query = new Query($score);
</code>
</div>
</div>
<p>Chaque fonction de décroissance est caratérisée par les propriétés <span class="inline-code">origin</span>, <span class="inline-code">offset</span>, <span class="inline-code">scale</span> et <span class="inline-code">decay</span>.</p>
<ul><li><span class="inline-code">origin</span> est la valeur centrale à partir de laquelle sera calculée la distance de vos résultats. D'une manière générale, plus vos résultats s'éloigneront de cette valeur centrale, plus le score sera réduit.</li>
<li><span class="inline-code">offset</span> est la distance à partir de laquelle s'appliquera votre fonction de décroissance. Avant cette distance le score ne sera pas modifié.</li>
<li><span class="inline-code">scale</span> est la valeur à laquelle votre fonction de décroissance appliquera la réduction souhaitée.</li>
<li><span class="inline-code">decay</span> est la valeur de réduction de score souhaitée (pourcentage de 0 à 1).</li>
</ul><p>Dans l'exemple ci-dessus, la valeur centrale est le 24 avril 2017 et on souhaite qu'à 6 jours (1 jour d'offset + 5 jours de scale) de cette date, soit le 18 et le 30 avril, le score soit réduit de moitié. La réduction du score des autres résultats sera calculée par la fonction de décroissance choisie.</p>
<p>Il existe 3 fonctions de décroissances, <a href="https://fr.wikipedia.org/wiki/Fonction_lin%C3%A9aire" target="_blank">linéaire</a>, <a href="https://fr.wikipedia.org/wiki/Fonction_exponentielle" target="_blank">exponentielle</a> et <a href="https://fr.wikipedia.org/wiki/Fonction_gaussienne" target="_blank">gaussienne</a>.</p>
<p>La fonction linéaire est une droite, la décroissance est proportionelle à la distance. Avec la fonction exponentielle, la décroissance est très forte au début et diminue rapidement avec la distance jusqu'à tendre vers zero. Avec la fonction gaussienne, la décroissance est également très forte au début mais diminue moins rapidement.</p>
<img src="/images/posts/2017/es-decay-graph.png" alt="Decay functions" title="Decay functions" id="decay-functions"><p>Les fonctions de décroissance peuvent être appliquées sur des valeurs numériques, des dates (<span class="inline-code">offset</span> et <span class="inline-code">scale</span> sont alors exprimés en durée : 5h ou 1d par exemple) ou des géopoints (<span class="inline-code">offset</span> et <span class="inline-code">scale</span> sont alors exprimés en distance : 100m ou 5km par exemple).</p>
<h2 id="conclusion">Conclusion<a href="#conclusion" class="anchor"></a></h2>
<p>Avec toutes ces fonctionnalités, vous dévriez être capables de gérer la pertinence de votre moteur de recherche assez finement. Attention néanmoins, cet article n'est pas exhaustif, <strong>ElasticSearch</strong> propose bien d'autres possibilités.</p>
<p>L'important est de ne pas se limiter à la configuration de base et d'adapter l'algorithme de score à vos données et vos besoins.</p>
<style type="text/css">
    .container .tabs .nav { background: #ccc; }
    .container .tabs .nav:before, .tabs .nav:after { content: ""; display: table; clear: both; }
    .container .tabs .nav a { float: left; display: block; padding: 5px 10px; margin: 0; text-decoration: none; }
    .container .tabs .nav a.active { background-color: #444; color: #fff; }
    .container .tabs .tab { display: none; clear: both; }
    .container .tabs .tab.active { display: block; }
</style><script type="text/javascript">
    function Tabs (element)
    {
        this.element = element;
        this.links   = element.querySelectorAll('.nav a');
        this.tabs    = element.querySelectorAll('.tab');

        [].forEach.call(this.links, function (link) {
            link.addEventListener('click', function (event) {
                event.preventDefault();
                this.open(link);
            }.bind(this));
        }.bind(this));
    }

    Tabs.prototype.open = function (link)
    {
        [].forEach.call(this.links, function (link) { link.classList.remove('active'); });
        [].forEach.call(this.tabs, function (tab) { tab.classList.remove('active'); });

        link.classList.add('active');
        this.element.querySelector(link.getAttribute('href')).classList.add('active');
    };

    [].forEach.call(document.querySelectorAll('.tabs'), function (element) { new Tabs(element); });
</script></body>
  </div>

  <div>
    <img src="/elao_/pr/42/images/authors/mcolin.jpg" />

    <p>Écrit par Maxime COLIN<p>

          <a href=colin_maxime>Twitter</a>
              <a href=maximecolin>Github</a>
              <a href=http://www.maximecolin.fr>Website</a>
      </div>

  <h4>Ces articles pourraient vous intéresser:</h4>

        </main>
                    <footer class="footer">
                <section class="footer__links">
                    <p class="h1 h1--small">
                        elao
                        <span>développe</span>
                         <span>du lien</span>
                    </p>
                    <div class="links">
                        <ul>
                            <li>
                                <a href="#">Nos services</a>
                            </li>
                            <li>
                                <a href="#">Nos études de cas</a>
                            </li>
                            <li>
                                <a href="#">Blog</a>
                            </li>
                            <li>
                                <a href="#">Notre méthodologie</a>
                            </li>
                            <li>
                                <a href="#">La tribu</a>
                            </li>
                            <li>
                                <a href="#">Contact</a>
                            </li>
                            <li>
                                <a href="#">Nos valeurs</a>
                            </li>
                            <li>
                                <a href="#">Nous recrutons <span class="bullet">3</span></a>
                            </li>
                        </ul>
                    </div>
                    <div class="socials">
                        <ul>
                            <li>
                                <a href="#">
                                    <i class="icon icon--github"></i>
                                    Github
                                </a>
                            </li>
                            <li>
                                <a href="#">
                                    <i class="icon icon--twitter"></i>
                                    Twitter
                                </a>
                            </li>
                            <li>
                                <a href="#">
                                    <i class="icon icon--instagram"></i>
                                    Instagram
                                </a>
                            </li>
                        </ul>
                    </div>
                </section>
                <section class="footer__legals">
                    <span>© 2014/2020 - ELAO - Tous droits réservés</span>
                    <a href="#">Mentions légales</a>
                    <a href="#">Protection des données</a>
                </section>
            </footer>
        </div>
                            <script src="/elao_/pr/42/build/runtime.fba8f3d8.js"></script><script src="/elao_/pr/42/build/app.a7244376.js"></script>
                    </body>
</html>
