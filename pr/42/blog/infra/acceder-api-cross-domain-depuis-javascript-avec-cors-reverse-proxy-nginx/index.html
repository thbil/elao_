<!DOCTYPE html>
<html lang="fr">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Elao_</title>

                    <!-- Open Graph / Facebook -->
             <meta property="og:title" content="Elao_" />
            <meta property="og:locale" content="fr" />
            <meta name="description" content="Elao est un atelier de co-conception d&#039;applications web et mobile sur mesure." />
            <meta property="og:description" content="Elao est un atelier de co-conception d&#039;applications web et mobile sur mesure." />
            <link rel="canonical" href="https://elao.github.io/elao_/pr/42/blog/infra/acceder-api-cross-domain-depuis-javascript-avec-cors-reverse-proxy-nginx" />
            <meta property="og:url" content="https://elao.github.io/elao_/pr/42/blog/infra/acceder-api-cross-domain-depuis-javascript-avec-cors-reverse-proxy-nginx" />
            <meta property="og:site_name" content="elao_" />
            
            <!-- Twitter -->
            <meta property="twitter:card" content="summary">
            <meta property="twitter:title" content="Elao_">
            <meta property="twitter:description" content="Elao est un atelier de co-conception d&#039;applications web et mobile sur mesure.">
            <meta property="twitter:site" content="@tom32i">
            <meta property="twitter:creator" content="@tom32i">
                    
                    <link rel="stylesheet" href="/elao_/pr/42/build/style.303f0a03.css">
            </head>
    <body>
        <header class="header">
            <div class="container">
                                    <!--
                        Todo :
                        - only on homepage : on scroll .logo.logo--animated becomes .logo.logo--animated.logo--active (triggers its animation)
                     -->
                    <a href="/elao_/pr/42/">
                        <span class="screen-reader">Elao_</span>
                                                    <svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" viewBox="0 0 300 100" class="logo logo--animated">
                                <path d="M61.6,61.6H19.7C21,69,24.8,72.2,32.6,72.2c5.9,0,8.8-1.9,11.7-7.8l16.1,6.9C56.2,82,46.9,87.8,32.1,87.8
                                    c-19.1,0-32-12.6-32-31.6c0-19.5,12.6-32.6,31.4-32.6c18.1,0,30.3,12.6,30.3,31.6C61.7,57.2,61.7,58.9,61.6,61.6z M19.6,49.3h23.6
                                    c-0.2-7.9-4.1-10.9-11.3-10.9S20.7,41.8,19.6,49.3z"/>
                                <path d="M71.2,0.1H90v86.5H71.2V0.1z"/>
                                <path d="M166.1,24.7v61.8h-18.8V72.7c-3.5,9.8-10.5,15.1-20.4,15.1c-17.7,0-27.4-12.9-27.4-32
                                    c0-19.4,9.3-32.2,26.2-32.2c10.5,0,18,5.4,21.6,15.6V24.7H166.1z M147.9,55.7c0-10.4-4.8-15.2-15.1-15.2c-9.9,0-14.6,4.8-14.6,15.2
                                    c0,10.1,4.7,14.9,14.6,14.9C143.1,70.7,147.9,65.9,147.9,55.7L147.9,55.7z"/>
                                <path d="M242.8,55.8c0,19.9-15.3,32-33.6,32s-33.6-12.1-33.6-32s15.3-32.2,33.6-32.2S242.8,35.8,242.8,55.8z M224,55.8
                                    c0-10.4-4.7-15.2-14.8-15.2c-10.1,0-14.8,4.8-14.8,15.2c0,10.1,4.7,14.9,14.8,14.9S224,65.9,224,55.8L224,55.8z"/>
                                <rect x="243.1" y="86.5" width="56.7" height="15"/>
                            </svg>
                                            </a>
                
                
                                    <!--
                        Todo :
                        - open / close mobile nav on click on .nav-toggle buttons
                        - when mobile nav is open, .body is .body.no-scroll to prevent background scroll
                     -->
                    <!-- Desktop nav -->
                    <nav class="nav">
                        <ul>
                                                            <li class="nav__item">
                                    <a href="/elao_/pr/42/nos-services">
                                                                                <span>Nos services</span>
                                    </a>
                                </li>
                                                            <li class="nav__item">
                                    <a href="/elao_/pr/42/methodo">
                                                                                <span>Notre méthodologie</span>
                                    </a>
                                </li>
                                                            <li class="nav__item">
                                    <a href="/elao_/pr/42/nos-valeurs">
                                                                                <span>Nos valeurs</span>
                                    </a>
                                </li>
                                                            <li class="nav__item">
                                    <a href="/elao_/pr/42/la-tribu/">
                                                                                <span>La tribu</span>
                                    </a>
                                </li>
                                                            <li class="nav__item">
                                    <a href="/elao_/pr/42/blog/">
                                                                                <span>Blog</span>
                                    </a>
                                </li>
                                                            <li class="nav__item">
                                    <a href="/elao_/pr/42/contact">
                                                                                    <i class="icon icon--contact" aria-hidden="true"></i>
                                                                                <span>Contact</span>
                                    </a>
                                </li>
                                                    </ul>
                    </nav>
                
                                    <!-- Mobile nav -->
                    <nav class="nav-mobile">
                        <div class="nav-mobile__header">
                            <a href="/elao_/pr/42/">
                                                            <svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" viewBox="0 0 300 100" class="logo logo--animated">
                                <path d="M61.6,61.6H19.7C21,69,24.8,72.2,32.6,72.2c5.9,0,8.8-1.9,11.7-7.8l16.1,6.9C56.2,82,46.9,87.8,32.1,87.8
                                    c-19.1,0-32-12.6-32-31.6c0-19.5,12.6-32.6,31.4-32.6c18.1,0,30.3,12.6,30.3,31.6C61.7,57.2,61.7,58.9,61.6,61.6z M19.6,49.3h23.6
                                    c-0.2-7.9-4.1-10.9-11.3-10.9S20.7,41.8,19.6,49.3z"/>
                                <path d="M71.2,0.1H90v86.5H71.2V0.1z"/>
                                <path d="M166.1,24.7v61.8h-18.8V72.7c-3.5,9.8-10.5,15.1-20.4,15.1c-17.7,0-27.4-12.9-27.4-32
                                    c0-19.4,9.3-32.2,26.2-32.2c10.5,0,18,5.4,21.6,15.6V24.7H166.1z M147.9,55.7c0-10.4-4.8-15.2-15.1-15.2c-9.9,0-14.6,4.8-14.6,15.2
                                    c0,10.1,4.7,14.9,14.6,14.9C143.1,70.7,147.9,65.9,147.9,55.7L147.9,55.7z"/>
                                <path d="M242.8,55.8c0,19.9-15.3,32-33.6,32s-33.6-12.1-33.6-32s15.3-32.2,33.6-32.2S242.8,35.8,242.8,55.8z M224,55.8
                                    c0-10.4-4.7-15.2-14.8-15.2c-10.1,0-14.8,4.8-14.8,15.2c0,10.1,4.7,14.9,14.8,14.9S224,65.9,224,55.8L224,55.8z"/>
                                <rect x="243.1" y="86.5" width="56.7" height="15"/>
                            </svg>
                        
                            </a>
                            <button class="nav-toggle nav-toggle--close">
                                <i class="icon icon--close" aria-hidden="true"></i>
                                <span class="screen-reader">Fermer le menu</span>
                            </button>
                        </div>
                        <ul>
                                                            <li class="nav-mobile__item">
                                    <a href="/elao_/pr/42/nos-services">
                                                                                <span>Nos services</span>
                                    </a>
                                </li>
                                                            <li class="nav-mobile__item">
                                    <a href="/elao_/pr/42/methodo">
                                                                                <span>Notre méthodologie</span>
                                    </a>
                                </li>
                                                            <li class="nav-mobile__item">
                                    <a href="/elao_/pr/42/etudes-de-cas/">
                                                                                <span>Nos études de cas</span>
                                    </a>
                                </li>
                                                            <li class="nav-mobile__item">
                                    <a href="/elao_/pr/42/nos-valeurs">
                                                                                <span>Nos valeurs</span>
                                    </a>
                                </li>
                                                            <li class="nav-mobile__item">
                                    <a href="/elao_/pr/42/la-tribu/">
                                                                                <span>La tribu</span>
                                    </a>
                                </li>
                                                            <li class="nav-mobile__item">
                                    <a href="/elao_/pr/42/blog/">
                                                                                <span>Blog</span>
                                    </a>
                                </li>
                                                            <li class="nav-mobile__item">
                                    <a href="/elao_/pr/42/contact">
                                                                                    <i class="icon icon--contact" aria-hidden="true"></i>
                                                                                <span>Contact</span>
                                    </a>
                                </li>
                                                    </ul>
                    </nav>
                    <button class="nav-toggle nav-toggle--open">
                        <i class="icon icon--hamburger" aria-hidden="true"></i>
                        <span class="screen-reader">Ouvrir le menu</span>
                    </button>
                            </div>
        </header>
        <div class="container">
        <main>
              <img src="/elao_/pr/42/images/posts/thumbnails/bridge.jpg" />

  <div>
    <img src="/elao_/pr/42/images/authors/mcolin.jpg" />
    <p>Écrit par Maxime COLIN<p>
    <p>Publication 3 novembre 2016<p>
    <p>Modification 21 septembre 2020<p>
  </div>

  <div>
          <a href="/elao_/pr/42/blog/tag/nginx">#nginx</a>
          <a href="/elao_/pr/42/blog/tag/reverse">#reverse</a>
          <a href="/elao_/pr/42/blog/tag/proxy">#proxy</a>
          <a href="/elao_/pr/42/blog/tag/infra">#infra</a>
          <a href="/elao_/pr/42/blog/tag/cors">#cors</a>
          <a href="/elao_/pr/42/blog/tag/api">#api</a>
          <a href="/elao_/pr/42/blog/tag/javascript">#javascript</a>
      </div>

  <div>
    <h1>Accéder à une API cross-domain depuis Javascript avec CORS et un reverse proxy nginx</h1>
    <p>Configurer un reverse proxy avec nginx et CORS pour permettre à une application Javascript d&#039;accéder à une API sur un autre domaine en contournant la Same Origin Policy.</p>
  </div>

  <div>
    <body><h2 id="introduction">Introduction<a href="#introduction" class="anchor"></a></h2>
<p>Dans la continuité de l'émergence des applications full frontend, nous sommes de plus en plus amenés a appeler des API directement en Javascript depuis le client. J'ai récemment été confronté à un cas où l'API à interroger n'était pas sur le même domaine que l'application. Sur un développement backend ce genre de cas ne pose aucun problème mais avec Javascript, pour des raisons de sécurité, les communications <strong>cross-domain</strong> sont bloquées par la <a href="https://developer.mozilla.org/fr/docs/Web/JavaScript/Same_origin_policy_for_JavaScript" target="_blank">Same Origin Policy</a>.</p>
<h2 id="cors">CORS<a href="#cors" class="anchor"></a></h2>
<p><a href="http://www.w3.org/TR/cors/" target="_blank">Cross-Origin Resource Sharing</a> (CORS) est une spécification du W3C permettant les requêtes <strong>cross-domain</strong> depuis les navigateurs compatibles. Si l'API que vous interrogez est compatible avec <strong>CORS</strong>, vous pourrez accéder à l'API même si elle n'est pas sur le même domaine que votre application.</p>
<p>CORS est compatible avec :</p>
<ul><li>Chrome 3+</li>
<li>Firefox 3.5+</li>
<li>Opera 12+</li>
<li>Safari 4+</li>
<li>Internet Explorer 8+</li>
</ul><p>Pour utiliser <strong>CORS</strong> il faut envoyer au serveur des <em>headers</em> de contrôle d'accès qu'il inspectera pour approuver ou non la requête. Ces <em>headers</em> de contrôle d'accès décriront le contexte de la requête, sa méthode HTTP, son origine, ses headers custom, ...</p>
<p>Selon le type de requête, ces headers sont envoyés automatiquement par le navigateur avec la requête ou dans une requête préliminaire (<em>preflight request</em>). La requête aboutira si le serveur répond avec des headers de contrôle d'accès compatibles.</p>
<code id="047eb40fecb8065603007bd68677bed7">=&gt; OPTIONS https://api.com/foobar
- HEADERS -
Origin: http://application.com
Access-Control-Request-Method: POST
Access-Control-Request-Headers: Api-Key

&lt;= HTTP/1.1 204 No Content
- RESPONSE HEADERS -
Access-Control-Allow-Origin: http://application.com
Access-Control-Allow-Methods: GET, POST, OPTIONS
Access-Control-Max-Age: 86400
Access-Control-Allow-Headers: Api-Key</code>
<p>Pour plus d'informations sur le fonctionnement de <strong>CORS</strong>, je vous laisse lire les articles <a href="https://www.eriwen.com/javascript/how-to-cors/" target="_blank">Making Cross-Domain Requests with CORS</a> et <a href="http://blog.inovia-conseil.fr/?p=202" target="_blank">Démystifier CORS (Cross-Origin Resource Sharing)</a> qui sont très complets.</p>
<h2 id="reverse-proxy">Reverse Proxy<a href="#reverse-proxy" class="anchor"></a></h2>
<p>Malheureusement l'API que je souhaitais utiliser n'était pas compatible CORS. Si c'est votre cas également, il faudra alors passer par un proxy.</p>
<p><strong>Nginx</strong> permet simplement de mettre en place ce genre de <em>reverse proxy</em> grace à une configuration de ce type :</p>
<code id="cd0bafd5ad131e16bd297d14ce957274">server {
    listen          80;
    server_name     application.com;

    location /api {
        # Rewrite /api/resource/action?key=value to /resource/action?key=value
        RewriteRule                     ^/api/(.*)$ /$i [L,PT,QSA]

        # Activer le proxy
        proxy_set_header                X-Real-IP $remote_addr;
        proxy_set_header                X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_pass                      http://api.com;
        proxy_redirect                  off;
        proxy_buffers                   32 16k;
        proxy_busy_buffers_size         64k;
    }
}</code>
<p>Ainsi, votre application pourra appeler votre API sur <span class="inline-code">http://application.com/api</span> sans problème de <em>cross-origin</em>.</p>
<p>Si vous avez besoin d'exposer l'API sur un autre domaine ou sur un autre port que votre application, vous aurez  besoin de permettre le <em>cross-domain</em> grâce à <strong>CORS</strong>. Mon application tournant sur <span class="inline-code">localhost:8080</span>, j'ai décidé de mettre mon proxy sur <span class="inline-code">localhost:8181</span>.</p>
<code id="1bb25a12c878d233408d89355099949b">server {
    listen          8181;
    server_name     localhost;

    location / {

        # Activer le proxy
        proxy_set_header                X-Real-IP $remote_addr;
        proxy_set_header                X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_pass                      http://api.com;
        proxy_redirect                  off;
        proxy_buffers                   32 16k;
        proxy_busy_buffers_size         64k;

        # Ajouter les headers de contrôle d'accès CORS
        add_header    'Access-Control-Allow-Origin' '*' always;
        add_header    'Access-Control-Allow-Methods' 'GET, POST, OPTIONS' always;
        add_header    'Access-Control-Allow-Headers' 'Origin, X-Requested-With, Content-Type, Accept' always;
        add_header    'Access-Control-Allow-Credentials' 'true' always;
}</code>
<p>Je peux ainsi appeler l'API sur <span class="inline-code">localhost:8181</span> de façon transparente.</p>
<div style="border-left: 5px solid #ffa600;padding: 20px;margin: 20px 0;">
    Attention, <code id="8d68c4c0373523ca5273c49e75df63a5">Access-Control-Allow-Origin: '*'</code> autorise les requêtes <em>cross-origin</em> depuis n'importe quel domaine, en dev cela permet de facilement mettre CORS en place mais dans un soucis de sécurité il faudrait être plus restrictif.
</div>
<h2 id="bonus">Bonus<a href="#bonus" class="anchor"></a></h2>
<p>Vous pouvez encore améliorer votre proxy par exemple en ajoutant automatiquement des headers d'authentification si l'API en nécessite ou encore des headers de cache afin de reduire le temps de réponse ou d'économiser un éventuel quota imposé par l'API.</p>
<h2 id="conclusion">Conclusion<a href="#conclusion" class="anchor"></a></h2>
<p>Grâce a <strong>nginx</strong> vous pouvez donc créer un <em>reverse proxy</em> qui vous permettra d'accéder à une API directement depuis votre application front sur un domaine différent en contournant de façon sécurisée la <strong>Same Origin Policy</strong>.</p></body>
  </div>

  <div>
    <img src="/elao_/pr/42/images/authors/mcolin.jpg" />

    <p>Écrit par Maxime COLIN<p>

          <a href=colin_maxime>Twitter</a>
              <a href=maximecolin>Github</a>
              <a href=http://www.maximecolin.fr>Website</a>
      </div>

  <h4>Ces articles pourraient vous intéresser:</h4>

        </main>
                    <footer class="footer">
                <section class="footer__links">
                    <p class="h1 h1--small">
                        elao
                        <span>développe</span>
                         <span>du lien</span>
                    </p>
                    <div class="links">
                        <ul>
                            <li>
                                <a href="#">Nos services</a>
                            </li>
                            <li>
                                <a href="#">Nos études de cas</a>
                            </li>
                            <li>
                                <a href="#">Blog</a>
                            </li>
                            <li>
                                <a href="#">Notre méthodologie</a>
                            </li>
                            <li>
                                <a href="#">La tribu</a>
                            </li>
                            <li>
                                <a href="#">Contact</a>
                            </li>
                            <li>
                                <a href="#">Nos valeurs</a>
                            </li>
                            <li>
                                <a href="#">Nous recrutons <span class="bullet">3</span></a>
                            </li>
                        </ul>
                    </div>
                    <div class="socials">
                        <ul>
                            <li>
                                <a href="#">
                                    <i class="icon icon--github"></i>
                                    Github
                                </a>
                            </li>
                            <li>
                                <a href="#">
                                    <i class="icon icon--twitter"></i>
                                    Twitter
                                </a>
                            </li>
                            <li>
                                <a href="#">
                                    <i class="icon icon--instagram"></i>
                                    Instagram
                                </a>
                            </li>
                        </ul>
                    </div>
                </section>
                <section class="footer__legals">
                    <span>© 2014/2020 - ELAO - Tous droits réservés</span>
                    <a href="#">Mentions légales</a>
                    <a href="#">Protection des données</a>
                </section>
            </footer>
        </div>
                            <script src="/elao_/pr/42/build/runtime.fba8f3d8.js"></script><script src="/elao_/pr/42/build/app.a7244376.js"></script>
                    </body>
</html>
